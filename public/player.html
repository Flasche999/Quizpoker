<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker â€“ Spieler</title>
  <link rel="stylesheet" href="/style.css?v=4" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    /* Badges + Turn-Highlight */
    .badge{display:inline-block;font-weight:700;color:#000;background:#fff;border-radius:50%;width:20px;height:20px;line-height:20px;text-align:center;margin-left:6px;font-size:12px}
    .badge-s{border:2px solid #6aa6ff}
    .badge-b{border:2px solid #ff4d4d}
    .seat.turn,.spieler-box.turn{border:3px solid gold!important;box-shadow:0 0 10px rgba(255,215,0,.7);border-radius:10px}
    .seat.folded,.spieler-box.folded{opacity:.5;filter:saturate(.5)}
    .betline{font-size:12px;opacity:.9}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h3 class="h">Beitreten (Lobby)</h3>
      <div class="row" style="margin-top:8px;">
        <input id="inpCode" placeholder="Raumcode" />
        <input id="inpName" placeholder="Dein Name" />
        <button id="btnJoin" class="primary">Beitreten</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnReset">ðŸšª Raum wechseln / Reset</button>
      </div>
      <div class="status">Du bist in Raum: <code id="roomCode" class="small">â€”</code></div>
      <div class="status">UID: <code id="uidLbl" class="small">â€”</code></div>
      <div class="status">Chips: <strong id="chips">0</strong></div>
      <div class="status">Aktuelle Bet: <strong id="currentBet">0</strong></div>
      <div class="status" id="pStatus"></div>

      <h3 class="h" style="margin-top:16px;">Aktuelle Frage</h3>
      <div id="question" class="status" style="font-size:18px;">â€“</div>

      <div class="row" style="margin-top:10px;">
        <input id="inpAnswer" placeholder="Deine Antwort" style="flex:1;">
        <button id="btnSend">Antwort senden</button>
      </div>

      <h3 class="h" style="margin-top:16px;">Einsatz</h3>
      <div class="row" style="margin-top:8px;">
        <input id="betAmount" type="number" placeholder="Betrag" min="1" style="width:120px;">
        <button id="btnBet" class="primary">Setzen/Raise</button>
        <button id="btnCall">Mitgehen</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnAllin" class="ok">All-in</button>
        <button id="btnFold"  class="err">Passen (Fold)</button>
      </div>
    </aside>

    <main class="main">
      <h3 class="h">Lobby â€“ Virtueller Tisch</h3>
      <div class="table-wrap">
        <div class="table-circle" id="table">
          <div class="seat s0" data-seat="0"></div>
          <div class="seat s1" data-seat="1"></div>
          <div class="seat s2" data-seat="2"></div>
          <div class="seat s3" data-seat="3"></div>
          <div class="seat s4" data-seat="4"></div>
          <div class="seat s5" data-seat="5"></div>
          <div class="seat s6" data-seat="6"></div>
          <div class="seat s7" data-seat="7"></div>
          <div id="table-center2">ðŸ’° Pot: <strong id="pot">0</strong></div>
        </div>
      </div>
    </main>

    <aside class="right">
      <h3 class="h">Spieler (Liste)</h3>
      <div id="playerList"></div>
    </aside>
  </div>

  <script>
    const socket = io({ path: '/socket.io', transports: ['websocket','polling'] });
    const $ = (s) => document.querySelector(s);

    // UID stabil
    let UID = localStorage.getItem('qp_uid');
    if (!UID) { UID = (crypto?.randomUUID?.() || (Date.now() + Math.random().toString(16).slice(2))); localStorage.setItem('qp_uid', UID); }
    $('#uidLbl').textContent = UID;

    // Inputs
    const inpCode=$('#inpCode'), inpName=$('#inpName'), btnJoin=$('#btnJoin'), btnReset=$('#btnReset');
    const inpAnswer=$('#inpAnswer'), btnSend=$('#btnSend');
    const betAmount=$('#betAmount'), btnBet=$('#btnBet'), btnCall=$('#btnCall'), btnAllin=$('#btnAllin'), btnFold=$('#btnFold');

    // State
    let myName = localStorage.getItem('qp_name') || '';
    let myRoom = localStorage.getItem('qp_room') || '';
    let joinedOnce = false, lastVersion = -1;

    const currentState = {
      blinds: { small:null, big:null },
      turnUid: null,
      currentBet: 0
    };

    if (myName) inpName.value = myName;
    if (myRoom) inpCode.value = myRoom;

    const currentInputCode = () => (inpCode.value || '').toUpperCase().trim();
    const setJoinUI = (disabled) => { inpCode.disabled = disabled; inpName.disabled = disabled; btnJoin.disabled = disabled; };

    [inpCode, inpName].forEach(el=>el.addEventListener('keydown', e=>{ if(e.key==='Enter') btnJoin.click(); }));

    // Join
    btnJoin.onclick = () => {
      const code = currentInputCode();
      const name = (inpName.value || '').trim() || 'Spieler';
      if (joinedOnce) { $('#pStatus').textContent = 'Du bist bereits in der Lobby.'; return; }
      if (!code) { $('#pStatus').textContent = 'Bitte Raumcode eingeben.'; return; }
      if (!socket.connected) { $('#pStatus').textContent = 'Nicht verbunden â€“ kurz warten...'; return; }
      $('#pStatus').textContent = 'Beitreten...';
      socket.emit('player:join', { code, uid: UID, name });
    };

    btnReset.onclick = () => {
      localStorage.removeItem('qp_room'); myRoom=''; joinedOnce=false; setJoinUI(false);
      $('#roomCode').textContent = 'â€”'; $('#pStatus').textContent = 'Reset â€“ neuer Raum mÃ¶glich.';
      try { socket.disconnect(); } catch {}
      socket.connect(); setTimeout(()=>$('#pStatus').textContent='', 1000);
    };

    // Antworten
    btnSend.onclick = () => {
      const a = inpAnswer.value.trim(); if (!a) return;
      if (!socket.connected) { $('#pStatus').textContent = 'Nicht verbunden.'; return; }
      socket.emit('player:answer', { answer: a });
      inpAnswer.value = ''; $('#pStatus').textContent = 'Antwort gesendet.'; setTimeout(()=>$('#pStatus').textContent='', 800);
    };

    // Betting
    btnBet.onclick = () => {
      const amt = Math.max(1, parseInt(betAmount.value || '0', 10) || 0);
      socket.emit('player:bet', { amount: amt });
    };
    btnCall.onclick = () => socket.emit('player:call');
    btnAllin.onclick = () => socket.emit('player:allin');
    btnFold.onclick  = () => socket.emit('player:fold');

    // Rendering
    const playersByUid = new Map();

    function escapeHtml(s=''){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

    function renderSeats() {
      for (let i=0;i<8;i++){
        const slot = document.querySelector(`.seat[data-seat="${i}"]`);
        if (!slot) continue;
        slot.className = `seat s${i}`;
        slot.innerHTML = '<div class="avatar">â€”</div><div class="name">Frei</div><div class="chips">ðŸª™ 0</div>';
      }
      const arr = Array.from(playersByUid.values()).sort((a,b)=>(a.seat??99)-(b.seat??99));
      arr.forEach(p=>{
        if (typeof p.seat!=='number') return;
        const slot = document.querySelector(`.seat[data-seat="${p.seat}"]`); if(!slot) return;

        const isSB = (p.seat === (currentState.blinds?.small ?? null));
        const isBB = (p.seat === (currentState.blinds?.big ?? null));
        const sBadge = isSB ? '<span class="badge badge-s">S</span>' : '';
        const bBadge = isBB ? '<span class="badge badge-b">B</span>' : '';

        slot.innerHTML = `
          <div class="avatar">ðŸ™‚</div>
          <div class="name">${escapeHtml(p.name)} ${sBadge} ${bBadge}</div>
          <div class="chips">ðŸª™ ${p.chips ?? 0}</div>
          <div class="betline">Bet: ðŸª™ ${p.bet ?? 0} ${p.status==='folded'?'Â· (Fold)':''}${p.status==='allin'?' Â· (All-in)':''}</div>
        `;
        if (!p.connected) slot.classList.add('disconnected');
        if (p.status==='folded') slot.classList.add('folded');
        if (p.uid === currentState.turnUid) slot.classList.add('turn');
      });
    }

    function renderList() {
      const list = $('#playerList'); list.innerHTML = '';
      const arr = Array.from(playersByUid.values()).sort((a,b)=> (a.seat??99)-(b.seat??99));
      arr.forEach(p=>{
        const isSB = (p.seat === (currentState.blinds?.small ?? null));
        const isBB = (p.seat === (currentState.blinds?.big ?? null));
        const sBadge = isSB ? '<span class="badge badge-s">S</span>' : '';
        const bBadge = isBB ? '<span class="badge badge-b">B</span>' : '';

        const div = document.createElement('div');
        div.className = 'spieler-box' + (p.connected ? '' : ' disconnected') + (p.status==='folded'?' folded':'') + (p.uid===currentState.turnUid?' turn':'');
        div.innerHTML = `<strong>Sitz ${(p.seat??-1)+1}:</strong> ${escapeHtml(p.name)} ${sBadge} ${bBadge} â€“ ðŸª™ ${p.chips ?? 0} Â· Bet: ðŸª™ ${p.bet ?? 0} ${p.status==='folded'?'Â· (Fold)':''}${p.status==='allin'?' Â· (All-in)':''}`;
        list.appendChild(div);
      });
    }

    function renderAll() {
      renderSeats(); renderList();
      const me = playersByUid.get(UID); if (me) $('#chips').textContent = me.chips ?? 0;
      $('#currentBet').textContent = currentState.currentBet ?? 0;
    }

    // Sockets
    socket.on('connect', ()=>{
      $('#pStatus').textContent='Verbunden.'; setTimeout(()=>$('#pStatus').textContent='',800);
      if (myRoom && (currentInputCode()==='' || currentInputCode()===myRoom)) {
        socket.emit('hello', { uid: UID, room: myRoom });
      }
    });
    socket.on('disconnect', ()=>{ $('#pStatus').textContent='Verbindung getrennt.'; });

    socket.on('player:join-result',(r)=>{
      if (!r.ok) { $('#pStatus').textContent = r.error || 'Fehler beim Beitritt.'; return; }
      myRoom=r.code; myName=r.name;
      localStorage.setItem('qp_room', myRoom);
      localStorage.setItem('qp_name', myName);
      $('#roomCode').textContent = myRoom;
      $('#chips').textContent = r.chips ?? 0;
      $('#pStatus').textContent = `In Lobby: ${myName}`;
      joinedOnce = true; setJoinUI(true);
      setTimeout(()=>$('#pStatus').textContent='', 1000);
    });

    socket.on('state:full',(state)=>{
      const ver=(state.version??-1); if (ver<=lastVersion) return; lastVersion=ver;
      $('#roomCode').textContent = state.code || 'â€”';
      $('#question').textContent = state.question?.text || 'â€“';
      if (typeof state.pot==='number') $('#pot').textContent = state.pot;
      currentState.currentBet = state.currentBet || 0;
      currentState.blinds = state.blinds || { small:null, big:null };
      currentState.turnUid = state.turnUid || null;

      playersByUid.clear();
      (state.players||[]).forEach(p=>playersByUid.set(p.uid,p));
      renderAll();

      const me = playersByUid.get(UID);
      if (me && state.code && state.code===(localStorage.getItem('qp_room')||'')) { joinedOnce=true; setJoinUI(true); } else { setJoinUI(false); }
    });

    socket.on('players:update',(msg)=>{
      const ver=(msg.version??-1); if (ver<=lastVersion) return; lastVersion=ver;
      (msg.players||[]).forEach(p=>playersByUid.set(p.uid,p));
      renderAll();
    });

    socket.on('state:partial',(patch)=>{
      const ver=(patch.version??-1); if (ver<=lastVersion) return; lastVersion=ver;
      if (typeof patch.pot==='number') $('#pot').textContent = patch.pot;
      if (typeof patch.currentBet==='number') currentState.currentBet = patch.currentBet;
      if (patch.blinds) currentState.blinds = patch.blinds;
      if ('turnUid' in patch) currentState.turnUid = patch.turnUid;
      renderAll();
    });

    socket.on('question:show',(q)=>{
      const ver=(q.version??-1); if (ver<=lastVersion) return; lastVersion=ver;
      $('#question').textContent = q.text || 'â€“';
    });

    socket.on('status',(t)=>{ $('#pStatus').textContent=t; setTimeout(()=>$('#pStatus').textContent='',1500); });
  </script>
</body>
</html>
