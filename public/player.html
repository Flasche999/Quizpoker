<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker â€“ Spieler</title>
  <link rel="stylesheet" href="/style.css?v=4" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h3 class="h">Beitreten (Lobby)</h3>
      <div class="row" style="margin-top:8px;">
        <input id="inpCode" placeholder="Raumcode" />
        <input id="inpName" placeholder="Dein Name" />
        <button id="btnJoin" class="primary">Beitreten</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnReset">ðŸšª Raum wechseln / Reset</button>
      </div>
      <div class="status">Du bist in Raum: <code id="roomCode" class="small">â€”</code></div>
      <div class="status">UID: <code id="uidLbl" class="small">â€”</code></div>
      <div class="status">Chips: <strong id="chips">0</strong></div>
      <div class="status" id="pStatus"></div>

      <h3 class="h" style="margin-top:16px;">Aktuelle Frage</h3>
      <div id="question" class="status" style="font-size:18px;">â€“</div>

      <div class="row" style="margin-top:10px;">
        <input id="inpAnswer" placeholder="Deine Antwort" style="flex:1;">
        <button id="btnSend">Antwort senden</button>
      </div>
    </aside>

    <main class="main">
      <h3 class="h">Lobby â€“ Virtueller Tisch</h3>
      <div class="table-wrap">
        <div class="table-circle" id="table">
          <div class="seat s0" data-seat="0"></div>
          <div class="seat s1" data-seat="1"></div>
          <div class="seat s2" data-seat="2"></div>
          <div class="seat s3" data-seat="3"></div>
          <div class="seat s4" data-seat="4"></div>
          <div class="seat s5" data-seat="5"></div>
          <div class="seat s6" data-seat="6"></div>
          <div class="seat s7" data-seat="7"></div>
          <div id="table-center2">ðŸ’° Pot: <strong id="pot">0</strong></div>
        </div>
      </div>
    </main>

    <aside class="right">
      <h3 class="h">Spieler (Liste)</h3>
      <div id="playerList"></div>
    </aside>
  </div>

  <script>
    const socket = io({ transports:['websocket'], path:'/socket.io' });
    const $ = (s) => document.querySelector(s);

    // Stabile UID
    let UID = localStorage.getItem('qp_uid');
    if (!UID) { UID = (crypto?.randomUUID?.() || (Date.now()+Math.random().toString(16).slice(2))); localStorage.setItem('qp_uid', UID); }
    $('#uidLbl').textContent = UID;

    // Inputs
    const inpCode   = $('#inpCode');
    const inpName   = $('#inpName');
    const btnJoin   = $('#btnJoin');
    const btnReset  = $('#btnReset');
    const inpAnswer = $('#inpAnswer');
    const btnSend   = $('#btnSend');

    // State
    let myName      = localStorage.getItem('qp_name') || '';
    let myRoom      = localStorage.getItem('qp_room') || '';
    let joinedOnce  = false;         // gesperrt erst nach echtem Join
    let lastVersion = -1;            // damit Version 0 gerendert wird

    if (myName) inpName.value = myName;
    if (myRoom) inpCode.value = myRoom;

    const currentInputCode = () => (inpCode.value || '').toUpperCase().trim();
    const setJoinUI = (disabled) => { inpCode.disabled = disabled; inpName.disabled = disabled; btnJoin.disabled = disabled; };

    // Enter-Shortcut
    ;[inpCode, inpName].forEach(el => el.addEventListener('keydown', e => { if (e.key === 'Enter') btnJoin.click(); }));

    // Join Button
    btnJoin.onclick = () => {
      const code = currentInputCode();
      const name = (inpName.value || '').trim() || 'Spieler';
      if (joinedOnce) { $('#pStatus').textContent = 'Du bist bereits in der Lobby.'; return; }
      if (!code) { $('#pStatus').textContent = 'Bitte Raumcode eingeben.'; return; }
      $('#pStatus').textContent = 'Beitreten...';
      socket.emit('player:join', { code, uid: UID, name });
    };

    // Reset / Raum wechseln
    btnReset.onclick = () => {
      localStorage.removeItem('qp_room');
      myRoom = '';
      joinedOnce = false;
      setJoinUI(false);
      $('#roomCode').textContent = 'â€”';
      $('#pStatus').textContent = 'Reset â€“ neuer Raum mÃ¶glich.';
      try { socket.disconnect(); } catch {}
      socket.connect();
      setTimeout(()=>$('#pStatus').textContent = '', 1000);
    };

    // Antworten senden
    btnSend.onclick = () => {
      const a = inpAnswer.value.trim();
      if (!a) return;
      socket.emit('player:answer', { answer: a });
      inpAnswer.value = '';
      $('#pStatus').textContent = 'Antwort gesendet.'; setTimeout(()=>$('#pStatus').textContent='', 800);
    };

    // Rendering
    const playersByUid = new Map();

    function renderSeats() {
      for (let i = 0; i < 8; i++) {
        const slot = document.querySelector(`.seat[data-seat="${i}"]`);
        if (!slot) continue;
        slot.className = `seat s${i}`;
        slot.innerHTML = `
          <div class="avatar">â€”</div>
          <div class="name">Frei</div>
          <div class="chips">ðŸª™ 0</div>
        `;
      }
      const arr = Array.from(playersByUid.values()).sort((a,b) => (a.seat??99)-(b.seat??99));
      arr.forEach(p => {
        if (typeof p.seat !== 'number') return;
        const slot = document.querySelector(\`.seat[data-seat="\${p.seat}"]\`);
        if (!slot) return;
        slot.innerHTML = `
          <div class="avatar">ðŸ™‚</div>
          <div class="name">${p.name}</div>
          <div class="chips">ðŸª™ ${p.chips ?? 0}</div>
        `;
        if (!p.connected) slot.classList.add('disconnected');
      });
    }
    function renderList() {
      const list = $('#playerList'); list.innerHTML = '';
      const arr = Array.from(playersByUid.values()).sort((a,b)=> (a.seat??99)-(b.seat??99));
      arr.forEach(p => {
        const div = document.createElement('div');
        div.className = 'spieler-box' + (p.connected ? '' : ' disconnected');
        div.innerHTML = \`<strong>Sitz \${(p.seat??-1)+1}:</strong> \${p.name} â€“ ðŸª™ \${p.chips ?? 0}\`;
        list.appendChild(div);
      });
    }
    function renderAll() {
      renderSeats(); renderList();
      const me = playersByUid.get(UID); if (me) $('#chips').textContent = me.chips ?? 0;
    }

    // Socket Events
    socket.on('connect', () => {
      $('#pStatus').textContent = 'Verbunden.';
      setTimeout(()=>$('#pStatus').textContent='', 800);
      // Reconnect nur wenn Eingabecode = gespeicherter Raum oder leer
      if (myRoom && (currentInputCode() === '' || currentInputCode() === myRoom)) {
        socket.emit('hello', { uid: UID, room: myRoom });
      }
    });
    socket.on('disconnect', (r) => { $('#pStatus').textContent = 'Verbindung getrennt.'; });

    socket.on('player:join-result', (r) => {
      if (!r.ok) { $('#pStatus').textContent = r.error || 'Fehler beim Beitritt.'; return; }
      myRoom = r.code; myName = r.name;
      localStorage.setItem('qp_room', myRoom);
      localStorage.setItem('qp_name', myName);
      $('#roomCode').textContent = myRoom;
      $('#chips').textContent = r.chips ?? 0;
      $('#pStatus').textContent = `In Lobby: ${myName}`;
      joinedOnce = true; setJoinUI(true);
      setTimeout(()=>$('#pStatus').textContent='', 1000);
    });

    socket.on('state:full', (state) => {
      if ((state.version ?? -1) <= lastVersion) return;
      lastVersion = state.version ?? -1;
      $('#roomCode').textContent = state.code || 'â€”';
      $('#question').textContent = state.question?.text || 'â€“';
      if (typeof state.pot === 'number') $('#pot').textContent = state.pot;
      playersByUid.clear();
      (state.players || []).forEach(p => playersByUid.set(p.uid, p));
      renderAll();

      const me = playersByUid.get(UID);
      if (me && state.code && state.code === (localStorage.getItem('qp_room') || '')) {
        joinedOnce = true; setJoinUI(true);
      } else {
        setJoinUI(false);
      }
    });

    socket.on('players:update', (msg) => {
      if ((msg.version ?? -1) <= lastVersion) return;
      lastVersion = msg.version ?? -1;
      (msg.players || []).forEach(p => playersByUid.set(p.uid, p));
      renderAll();
    });

    socket.on('question:show', (q) => {
      if ((q.version ?? -1) <= lastVersion) return;
      lastVersion = q.version ?? -1;
      $('#question').textContent = q.text || 'â€“';
    });

    socket.on('status', (t) => { $('#pStatus').textContent = t; setTimeout(()=>$('#pStatus').textContent='', 1500); });
  </script>
</body>
</html>
