<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker – Spieler</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2 class="h">Beitreten</h2>
      <div class="row">
        <input class="input" id="room" placeholder="Raumcode (optional)" style="width:160px" />
        <input class="input" id="name" placeholder="Dein Name" style="width:220px" />
        <input class="input" id="avatar" placeholder="Avatar-URL (optional)" style="width:320px" />
        <button class="btn ok" id="joinBtn">Beitreten</button>
        <button class="btn bad" id="leaveBtn">Verlassen</button>
        <button class="btn" id="rebuyBtn">Rebuy</button>
      </div>
      <div class="small">Ohne Avatar-URL erhältst du automatisch einen generierten Avatar.</div>
    </div>

    <div class="card">
      <h2 class="h">Aktuelle Runde</h2>
      <div id="questionBox">Warte auf neue Runde…</div>
    </div>

    <div class="card">
      <h2 class="h">Virtueller Tisch</h2>
      <div class="table-wrap">
        <div class="table"></div>
        <div id="dealer" class="dealer">D</div>
        <div id="seats"></div>
        <div class="pot">
          Pot: <span id="pot">0</span>
          <span class="small" id="betInfo" style="margin-left:8px"></span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1;min-width:320px">
        <h2 class="h">Deine Schätzantwort</h2>
        <div id="guessBox">
          <div class="small">Gib nach Start deine Zahl ein (nur in Phase „Schätzung“).</div>
          <div class="row">
            <input class="input" id="guess" type="number" placeholder="z. B. 123" style="width:160px" />
            <button class="btn ok" id="sendGuess">Abschicken</button>
          </div>
          <div class="small" id="guessInfo">Warte auf Frage…</div>
        </div>
      </div>

      <div class="card" style="flex:1;min-width:320px">
        <h2 class="h">Aktionen</h2>
        <div class="row">
          <button class="btn act" data-act="check">Check</button>
          <button class="btn act" data-act="call">Call</button>
          <button class="btn act" data-act="raise">Raise</button>
          <input class="input" id="raiseAmt" type="number" placeholder="Betrag" style="width:120px" />
          <button class="btn act" data-act="allin">All-In</button>
          <button class="btn bad act" data-act="fold">Fold</button>
        </div>
        <div class="small" id="actInfo">Aktionen sind nur in Bet-Phasen möglich und wenn du dran bist.</div>
      </div>
    </div>
  </div>

<script>
const sock = io({ autoConnect: true });
let MY_ID = null, GLOBAL_STATE = null;
let PUBLIC_GUESSES = []; // [{sid,name,value,revealed}]

const $ = (id)=>document.getElementById(id);
const h = (html)=>{ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstElementChild; };
const setDisabled = (sel, v)=> document.querySelectorAll(sel).forEach(b=> b.disabled = v);
function escapeHtml(str){return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
function fmt(n){ return Number(n||0).toString(); }

const sounds = {
  buzzer: new Audio('/sounds/buzzer.mp3'),
  correct: new Audio('/sounds/correct.mp3'),
  wrong: new Audio('/sounds/wrong.mp3'),
};
Object.values(sounds).forEach(a=>{ a.preload='auto'; a.volume=1.0; });

sock.on('connect', ()=>{ MY_ID = sock.id; });
sock.on('sound', ({key})=>{ const a = sounds[key]; if(a){ try{ a.currentTime=0; a.play(); }catch(e){} }});
sock.on('errorMsg', (m)=> alert(m));

// Öffentliche Schätzungen (abhängig vom Reveal pro Spieler)
sock.on('guesses:public', rows => {
  PUBLIC_GUESSES = Array.isArray(rows) ? rows : [];
  if (GLOBAL_STATE) renderState(GLOBAL_STATE);
});

// Live-Action-Anzeige (Check/Call/Raise/All-In/Fold)
sock.on('actionInfo', ({sid, type, amount})=>{
  const st = GLOBAL_STATE; if(!st) return;
  const p = st.players?.[sid]; if(!p) return;
  const seatEl = $('seats').querySelector('.seat.s'+p.seat);
  showActionFlag(seatEl, type, amount);
});

// Haupt-State
sock.on('state', (st)=> renderState(st));

$('joinBtn').onclick = ()=>{
  const name = $('name').value.trim();
  const room = $('room').value.trim();
  const avatar = $('avatar').value.trim();
  if(!name){ alert('Bitte Namen eingeben.'); return; }
  // room wird serverseitig ignoriert – stört aber nicht
  sock.emit('join', { room, name, avatar });
};
$('leaveBtn').onclick = ()=> sock.emit('leaveTable');
$('rebuyBtn').onclick = ()=> sock.emit('rebuy');

$('sendGuess').onclick = ()=>{
  const v = Number($('guess').value);
  if(!Number.isFinite(v)){ alert('Bitte eine Zahl eingeben.'); return; }
  sock.emit('submitGuess', { value: v });
};

document.querySelectorAll('.act[data-act]').forEach(btn=>{
  btn.onclick = ()=>{
    const type = btn.getAttribute('data-act');
    const amountRaw = Number($('raiseAmt').value);
    const amount = Number.isFinite(amountRaw) ? Math.floor(amountRaw) : 0;
    if(type === 'raise' && amount <= 0){ alert('Bitte gültigen Raise-Betrag eingeben.'); return; }
    sock.emit('action', { type, amount });
  };
});

// ---------- UI-Helfer ----------
function showActionFlag(seatEl, type, amount){
  if (!seatEl) return;
  seatEl.querySelectorAll('.act-flag').forEach(n=>n.remove());
  const label = type==='raise' ? `Raise ${amount??''}` :
                type==='allin' ? 'All-In' :
                type==='call'  ? 'Call' :
                type==='check' ? 'Check' :
                type==='fold'  ? 'Fold'  : type;
  const flag = h(`<div class="act-flag ${type}">${label}</div>`);
  seatEl.appendChild(flag);
  if (type === 'fold') seatEl.classList.add('folded');
}

function guessForSid(sid){
  return PUBLIC_GUESSES.find(g=>g.sid===sid);
}

// ---------- Rendering ----------
function renderState(st){
  GLOBAL_STATE = st;
  const me = st?.players?.[MY_ID] || null;
  const round = st?.round || null;
  const table = st?.table || {pot:0,currentBet:0,minRaise:0,dealerSeat:null,actingSeat:null};
  const q = round?.question || null;

  $('questionBox').innerHTML = q ? [
    `<div><b>Frage:</b> ${q.frage ?? '—'}</div>`,
    `<div class="small"><b>Hinweis 1:</b> ${round?.hintsRevealed >= 1 ? (q.hinweis1 ?? '—') : '• • •'}</div>`,
    `<div class="small"><b>Hinweis 2:</b> ${round?.hintsRevealed >= 2 ? (q.hinweis2 ?? '—') : '• • •'}</div>`,
    `<div class="small"><b>Lösung:</b> ${['reveal','reveal_bet','showdown'].includes(round?.phase) ? (q.loesung ?? '—') : '• • •'}</div>`,
    `<div><b>Phase:</b> ${round?.phase ?? '—'}</div>`
  ].join('') : 'Warte auf neue Runde…';

  // Guess-UI
  const canGuess = !!(round && round.phase === 'collect_guesses' && me && !me.hasGuessed);
  $('guess').disabled = !canGuess;
  $('sendGuess').disabled = !canGuess;
  $('guessInfo').textContent = round
    ? (round.phase === 'collect_guesses'
        ? (me?.hasGuessed ? 'Schätzung abgegeben. Warte auf andere…' : 'Gib jetzt deine Schätzung ab!')
        : 'Schätz-Phase vorbei.')
    : 'Warte auf nächste Frage…';

  // Bet-Phasen: nur diese Phasen sind für Spieleraktionen relevant
  const betPhases = ['bet1','bet2','bet3','reveal_bet'];
  const isBet = betPhases.includes(round?.phase);
  const iAmActing = isBet && me && (table.actingSeat === me.seat) && me.inHand;
  setDisabled('.act', !iAmActing);
  $('actInfo').textContent = iAmActing
    ? (round?.phase==='reveal_bet' ? 'Finale Setzrunde: Du bist dran.' : 'Du bist dran.')
    : (isBet ? 'Warte bis du dran bist…' : 'Aktionen nur in Bet-Phasen.');

  // Seats rendern – SITZ 2 und 6 komplett entfernen (nicht anzeigen)
  const seatsWrap = $('seats'); seatsWrap.innerHTML='';
  const seats = Array.isArray(st?.seats) ? st.seats : [];
  seats.forEach((sid,i)=>{
    if (i === 2 || i === 6) return; // komplett aus der Spieler-Ansicht raus

    const p = sid ? st.players[sid] : null;
    const seat = h(`<div class="seat s${i}"></div>`);
    if(p){
      const avatar = p.avatar && p.avatar.length ? p.avatar
        : `https://api.dicebear.com/7.x/thumbs/svg?seed=${encodeURIComponent(p.name||'X')}`;
      seat.innerHTML = `
        <img src="${avatar}" alt="avatar"/>
        <div class="name">${escapeHtml(p.name||'')}</div>
        <div class="chips">${fmt(p.chips ?? 0)} Chips</div>
      `;

      // DRAN
      if(typeof table.actingSeat === 'number' && table.actingSeat === p.seat){
        seat.classList.add('turn');
        if(!seat.querySelector('.turn-pill')){
          seat.appendChild(h('<div class="turn-pill">DRAN</div>'));
        }
      }

      // OUT / Fold
      if (p.isOut){
        seat.classList.add('out');
        if(!seat.querySelector('.out-pill')) seat.appendChild(h('<div class="out-pill">OUT</div>'));
      }
      if (p.lastAction?.type === 'fold') seat.classList.add('folded');

      // Letzte Aktion am Sitz
      if (p.lastAction){
        showActionFlag(seat, p.lastAction.type, p.lastAction.amount);
      }

      // Guess-Chip (öffentlich, ggf. „•••“)
      const g = guessForSid(p.id);
      if (g){
        const text = g.revealed ? `Guess: ${g.value}` : 'Guess: •••';
        const chip = h(`<div class="guess-chip${g.revealed?'':' dim'}">${text}</div>`);
        seat.appendChild(chip);
      } else if (p.hasGuessed) {
        seat.appendChild(h('<div class="guess-chip dim">Guess abgegeben</div>'));
      }
    }else{
      seat.innerHTML = `<div class="name">(frei)</div><div class="chips">—</div>`;
    }
    seatsWrap.appendChild(seat);
  });

  // Pot / Bet Info
  $('pot').textContent = fmt(table.pot ?? 0);
  $('betInfo').textContent = `Bet: ${fmt(table.currentBet ?? 0)} | Min Raise: ${fmt(table.minRaise ?? 0)}`;

  positionDealerBadge();
}

function positionDealerBadge(){
  const st = GLOBAL_STATE;
  const seatsWrap = $('seats');
  const dealer = $('dealer');
  dealer.style.display = 'none';
  const dSeat = st?.table?.dealerSeat;
  if(typeof dSeat !== 'number') return;
  // In der Spieler-Ansicht existieren 2/6 nicht – Badge dort ausblenden
  if (dSeat === 2 || dSeat === 6) return;
  const dEl = seatsWrap.querySelector('.seat.s'+dSeat);
  if(!dEl) return;
  dealer.style.display = 'block';
  dealer.style.left = (dEl.offsetLeft + 6) + 'px';
  dealer.style.top  = (dEl.offsetTop - 12) + 'px';
}
</script>
</body>
</html>
