<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker – Spieler</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2 class="h">Beitreten</h2>
      <div class="row">
        <input class="input" id="name" placeholder="Dein Name" style="width:220px" />
        <input class="input" id="avatar" placeholder="Avatar-URL (optional)" style="width:320px" />
        <button class="btn ok" id="joinBtn">Beitreten</button>
        <button class="btn bad" id="leaveBtn">Verlassen</button>
        <button class="btn" id="rebuyBtn" title="+Startchips hinzufügen">Rebuy</button>
      </div>
      <div class="small">Ohne Avatar-URL bekommst du automatisch einen generierten Avatar.</div>
    </div>

    <div class="card">
      <h2 class="h">Aktuelle Runde</h2>
      <div id="questionBox">Warte auf neue Runde…</div>
    </div>

    <div class="card">
      <h2 class="h">Virtueller Tisch</h2>
      <div class="table-wrap">
        <div class="table"></div>
        <div id="dealer" class="dealer">D</div>
        <div id="seats"></div>
        <div class="pot">Pot: <span id="pot">0</span></div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1">
        <h2 class="h">Deine Schätzantwort</h2>
        <div id="guessBox">
          <div class="small">Gib sofort nach Start deine Zahl ein (nur in Phase "Schätzung").</div>
          <div class="row">
            <input class="input" id="guess" type="number" placeholder="z. B. 123" style="width:160px" />
            <button class="btn ok" id="sendGuess">Abschicken</button>
          </div>
          <div class="small" id="guessInfo">Warte auf Frage…</div>
        </div>
      </div>

      <div class="card" style="flex:1">
        <h2 class="h">Aktionen</h2>
        <div class="row">
          <button class="btn" data-act="check">Check</button>
          <button class="btn" data-act="call">Call</button>
          <button class="btn" data-act="raise">Raise</button>
          <input class="input" id="raiseAmt" type="number" placeholder="Betrag" style="width:120px" />
          <button class="btn" data-act="allin">All-In</button>
          <button class="btn bad" data-act="fold">Fold</button>
        </div>
        <div class="small">Aktionen sind nur in den Bet-Phasen möglich und wenn du dran bist.</div>
      </div>
    </div>
  </div>

<script>
const sock = io();
let MY_ID = null, GLOBAL_STATE = null;

function el(id){return document.getElementById(id)}
function h(html){const d=document.createElement('div');d.innerHTML=html;return d.firstElementChild}

sock.on('connect', ()=>{ MY_ID = sock.id; });

el('joinBtn').onclick = ()=> sock.emit('join', { name: el('name').value, avatar: el('avatar').value });
el('leaveBtn').onclick = ()=> sock.emit('leaveTable');
el('rebuyBtn').onclick = ()=> sock.emit('rebuy');

el('sendGuess').onclick = ()=>{
  const v = Number(el('guess').value);
  if(Number.isFinite(v)) sock.emit('submitGuess', { value: v });
};

document.querySelectorAll('[data-act]').forEach(btn=>{
  btn.onclick = ()=>{
    const type = btn.getAttribute('data-act');
    const amount = Number(el('raiseAmt').value);
    sock.emit('action', { type, amount });
  };
});

function renderState(st){
  GLOBAL_STATE = st; const me = st.players[MY_ID];
  const q = st.round?.question;
  el('questionBox').innerHTML = q ? `
    <div><b>Frage:</b> ${q.frage}</div>
    <div><b>Hinweis 1:</b> ${q.hinweis1 ?? '—'}</div>
    <div><b>Hinweis 2:</b> ${q.hinweis2 ?? '—'}</div>
    <div><b>Lösung:</b> ${q.loesung ?? '—'}</div>
    <div><b>Phase:</b> ${st.round.phase}</div>
  ` : 'Warte auf neue Runde…';

  const canGuess = st.round.phase === 'collect_guesses' && me;
  el('guess').disabled = !canGuess || me?.hasGuessed;
  el('sendGuess').disabled = !canGuess || me?.hasGuessed;
  el('guessInfo').textContent = canGuess ? (me?.hasGuessed ? 'Schätzung abgegeben. Warte auf andere…' : 'Gib jetzt deine Schätzung ab!') : 'Warte auf nächste Frage…';

  const seatsWrap = el('seats'); seatsWrap.innerHTML='';
  st.seats.forEach((sid,i)=>{
    const p = sid ? st.players[sid] : null;
    const seat = h(`<div class="seat s${i}"></div>`);
    seat.innerHTML = p ? `
      ${p.avatar?`<img src="${p.avatar}" alt="avatar"/>`:`<img src="https://api.dicebear.com/7.x/thumbs/svg?seed=${encodeURIComponent(p?.name||'X')}" alt="avatar"/>`}
      <div class="name">${p.name}</div>
      <div class="chips">${p.chips} Chips</div>
    ` : `<div class="name">(frei)</div><div class="chips">—</div>`;
    if(p && st.round.actingSeat===p.seat){ seat.classList.add('turn'); }
    seatsWrap.appendChild(seat);
  });
  el('pot').textContent = st.round.pot;

  const dealer = el('dealer'); dealer.style.display='none';
  const dSeat = st.table.dealerSeat; const dEl = seatsWrap.querySelector('.seat.s'+dSeat);
  if(dEl){ dealer.style.display='block'; dealer.style.left=(dEl.offsetLeft + 8)+'px'; dealer.style.top=(dEl.offsetTop - 12)+'px'; }
}

sock.on('state', renderState);
sock.on('errorMsg', (m)=> alert(m));
sock.on('sound', ({key})=>{
  const m={buzzer:'/sounds/buzzer.mp3',correct:'/sounds/correct.mp3',wrong:'/sounds/wrong.mp3'};
  const a=new Audio(m[key]); a&&a.play&&a.play().catch(()=>{});
});
</script>
</body>
</html>
