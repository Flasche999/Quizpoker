<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker â€“ Spieler</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* Zusatz-Stile nur fÃ¼r den runden Tisch */
    :root { --ring: 460px; --seat: 96px; }
    .table-wrap { display:flex; justify-content:center; }
    .table-circle {
      position:relative; width:var(--ring); height:var(--ring);
      margin:10px auto; border-radius:50%;
      background: radial-gradient(closest-side, #11213a 0%, #0d172a 60%, #0b1220 100%);
      box-shadow: 0 0 0 2px #1d2636 inset, 0 10px 30px rgba(0,0,0,.5);
    }
    .seat {
      position:absolute; width:var(--seat); height:var(--seat);
      border-radius:14px; border:1px solid #26324a; background:#0b1220;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px; padding:8px; text-align:center;
      transform: translate(-50%, -50%);
    }
    .seat .avatar {
      width:48px; height:48px; border-radius:50%; background:#141a2a;
      display:flex; align-items:center; justify-content:center; border:1px solid #283552;
      font-weight:700; overflow:hidden;
    }
    .seat .name { font-size:13px; line-height:1.2; }
    .seat .chips { font-size:12px; opacity:.9; }
    .seat.disconnected { opacity:.5; filter:saturate(.5); }
    /* Sitzpositionen (0 oben, dann im Uhrzeigersinn) */
    .s0 { left:50%; top:7%; }
    .s1 { left:82%; top:20%; }
    .s2 { left:93%; top:50%; }
    .s3 { left:82%; top:80%; }
    .s4 { left:50%; top:93%; }
    .s5 { left:18%; top:80%; }
    .s6 { left:7%;  top:50%; }
    .s7 { left:18%; top:20%; }
    /* Center */
    #table-center2 {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      padding:10px 14px; border-radius:12px; border:1px solid #2a3650; background:#0f1420;
      text-align:center; font-size:14px;
    }

    @media (max-width: 560px) {
      :root { --ring: 320px; --seat: 84px; }
    }

    /* Kleinere Optik-Angleichung */
    .status code.small { font-size: 12px; }
    .primary[disabled] { opacity: .6; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h3 class="h">Beitreten</h3>
      <div class="row" style="margin-top:8px;">
        <input id="inpCode" placeholder="Raumcode" />
        <input id="inpName" placeholder="Dein Name" />
        <button id="btnJoin" class="primary">Beitreten</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnReset">ðŸšª Raum wechseln / Reset</button>
      </div>
      <div class="status">Du bist in Raum: <code id="roomCode" class="small">â€”</code></div>
      <div class="status">UID: <code id="uidLbl" class="small">â€”</code></div>
      <div class="status">Chips: <strong id="chips">0</strong></div>
      <div class="status" id="pStatus"></div>

      <h3 class="h" style="margin-top:16px;">Aktuelle Frage</h3>
      <div id="question" class="status" style="font-size:18px;">â€“</div>

      <div class="row" style="margin-top:10px;">
        <input id="inpAnswer" placeholder="Deine Antwort" style="flex:1;">
        <button id="btnSend">Antwort senden</button>
      </div>
    </aside>

    <main class="main">
      <h3 class="h">Virtueller Tisch</h3>
      <div class="table-wrap">
        <div class="table-circle" id="table">
          <!-- 8 SitzplÃ¤tze -->
          <div class="seat s0" data-seat="0"></div>
          <div class="seat s1" data-seat="1"></div>
          <div class="seat s2" data-seat="2"></div>
          <div class="seat s3" data-seat="3"></div>
          <div class="seat s4" data-seat="4"></div>
          <div class="seat s5" data-seat="5"></div>
          <div class="seat s6" data-seat="6"></div>
          <div class="seat s7" data-seat="7"></div>

          <div id="table-center2">ðŸ’° Pot: <strong id="pot">0</strong></div>
        </div>
      </div>
    </main>

    <aside class="right">
      <h3 class="h">Spieler (Liste)</h3>
      <div id="playerList"></div>
    </aside>
  </div>

  <script>
    // Verbesserte Socket.io-Initialisierung (stabilere Verbindungen + klares Fehlerbild)
    const socket = io({
      transports: ['websocket'],
      path: '/socket.io',
      reconnectionAttempts: 5,
      timeout: 15000
    });

    const $ = (s) => document.querySelector(s);

    // Stabile UID auf GerÃ¤t
    let UID = localStorage.getItem('qp_uid');
    if (!UID) {
      UID = (crypto?.randomUUID?.() || (Date.now() + Math.random().toString(16).slice(2)));
      localStorage.setItem('qp_uid', UID);
    }
    $('#uidLbl').textContent = UID;

    // Felder & Buttons
    const inpCode   = $('#inpCode');
    const inpName   = $('#inpName');
    const btnJoin   = $('#btnJoin');
    const btnReset  = $('#btnReset');
    const inpAnswer = $('#inpAnswer');
    const btnSend   = $('#btnSend');

    // Lokaler State
    let myName      = localStorage.getItem('qp_name') || '';
    let myRoom      = localStorage.getItem('qp_room') || '';
    let joinedOnce  = false;      // Clientseitige Blockade NUR nach echtem Join
    let lastVersion = -1;         // wichtig: -1, damit Version 0 gerendert wird

    if (myName) inpName.value = myName;
    if (myRoom) inpCode.value = myRoom;

    function currentInputCode() {
      return (inpCode.value || '').toUpperCase().trim();
    }

    function setJoinUI(disabled) {
      inpCode.disabled = disabled;
      inpName.disabled = disabled;
      btnJoin.disabled = disabled;
    }

    // Enter-Shortcut
    [inpCode, inpName].forEach(input => {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') btnJoin.click();
      });
    });

    // Join
    btnJoin.onclick = () => {
      const code = currentInputCode();
      const name = (inpName.value || '').trim() || 'Spieler';
      console.log('[UI] join click', { code, UID, name, joinedOnce });
      if (joinedOnce) { $('#pStatus').textContent = 'Du bist bereits beigetreten.'; return; }
      if (!code) { $('#pStatus').textContent = 'Bitte Raumcode eingeben.'; return; }
      $('#pStatus').textContent = 'Beitreten...';
      socket.emit('player:join', { code, uid: UID, name });
    };

    // Reset / Raum wechseln
    btnReset.onclick = () => {
      localStorage.removeItem('qp_room');
      myRoom = '';
      joinedOnce = false;
      setJoinUI(false);
      $('#roomCode').textContent = 'â€”';
      $('#pStatus').textContent = 'Reset â€“ du kannst einem neuen Raum beitreten.';
      try { socket.disconnect(); } catch {}
      socket.connect();
      setTimeout(()=>$('#pStatus').textContent = '', 1200);
    };

    // Antworten senden
    btnSend.onclick = () => {
      const a = inpAnswer.value.trim();
      if (!a) return;
      socket.emit('player:answer', { answer: a });
      inpAnswer.value = '';
      $('#pStatus').textContent = 'Antwort gesendet.';
      setTimeout(() => $('#pStatus').textContent = '', 1000);
    };

    // Rendering: Seats & Liste
    const playersByUid = new Map();

    function renderSeats() {
      // Alle Sitze erst mal "Frei" markieren
      for (let i = 0; i < 8; i++) {
        const slot = document.querySelector(`.seat[data-seat="${i}"]`);
        if (!slot) continue;
        slot.className = `seat s${i}`;
        slot.innerHTML = `
          <div class="avatar">â€”</div>
          <div class="name">Frei</div>
          <div class="chips">ðŸª™ 0</div>
        `;
      }

      // Spieler einsetzen
      const arr = Array.from(playersByUid.values());
      arr.forEach(p => {
        const si = (typeof p.seat === 'number') ? p.seat : null;
        if (si === null || si < 0 || si > 7) return;
        const slot = document.querySelector(\`.seat[data-seat="\${si}"]\`);
        if (!slot) return;
        slot.innerHTML = `
          <div class="avatar">${(p.avatar && p.avatar.startsWith('http')) ? `<img src="${p.avatar}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : 'ðŸ™‚'}</div>
          <div class="name">${p.name}</div>
          <div class="chips">ðŸª™ ${p.chips ?? 0}</div>
        `;
        if (!p.connected) slot.classList.add('disconnected');
      });
    }

    function renderList() {
      const list = $('#playerList');
      list.innerHTML = '';
      const arr = Array.from(playersByUid.values()).sort((a,b) => a.seat - b.seat);
      arr.forEach(p => {
        const div = document.createElement('div');
        div.className = 'spieler-box' + (p.connected ? '' : ' disconnected');
        div.innerHTML = \`<strong>Sitz \${(p.seat ?? '-') + 1}:</strong> \${p.name} â€“ ðŸª™ \${p.chips ?? 0}\`;
        list.appendChild(div);
      });
    }

    function renderAll() {
      renderSeats();
      renderList();
      // eigene Chips anzeigen
      const me = playersByUid.get(UID);
      if (me) $('#chips').textContent = me.chips ?? 0;
    }

    // Socket Events â€“ Status/Fehler sichtbar machen
    socket.on('connect', () => {
      console.log('[socket] connected', socket.id);
      $('#pStatus').textContent = 'Verbunden.';
      setTimeout(()=>$('#pStatus').textContent='', 1000);

      // Reconnect nur dann, wenn der gespeicherte Raum dem Eingabecode entspricht (oder leer ist)
      if (myRoom && (currentInputCode() === '' || currentInputCode() === myRoom)) {
        socket.emit('hello', { uid: UID, name: myName, room: myRoom });
      }
    });
    socket.on('disconnect', (reason) => {
      console.warn('[socket] disconnected', reason);
      $('#pStatus').textContent = 'Verbindung getrennt.';
    });
    socket.on('connect_error', (err) => {
      console.error('[socket] connect_error', err?.message || err);
      $('#pStatus').textContent = 'Socket-Fehler: ' + (err?.message || err);
    });
    socket.on('error', (err) => {
      console.error('[socket] error', err);
      $('#pStatus').textContent = 'Fehler: ' + (err?.message || err);
    });

    // Join-Ergebnis
    socket.on('player:join-result', (r) => {
      console.log('[player:join-result]', r);
      if (!r.ok) {
        $('#pStatus').textContent = r.error || 'Fehler beim Beitritt.';
        return;
      }
      // Erfolgreich
      myRoom = r.code; myName = r.name;
      localStorage.setItem('qp_room', myRoom);
      localStorage.setItem('qp_name', myName);
      $('#roomCode').textContent = myRoom;
      $('#chips').textContent = r.chips ?? 0;
      $('#pStatus').textContent = `Beigetreten als ${myName}`;
      joinedOnce = true;
      setJoinUI(true);
      setTimeout(() => $('#pStatus').textContent = '', 1200);
    });

    // VollstÃ¤ndiger State
    socket.on('state:full', (state) => {
      if ((state.version ?? -1) <= lastVersion) return;
      lastVersion = state.version ?? -1;

      $('#roomCode').textContent = state.code || 'â€”';
      $('#question').textContent = state.question?.text || 'â€“';
      if (typeof state.pot === 'number') $('#pot').textContent = state.pot;

      playersByUid.clear();
      (state.players || []).forEach(p => playersByUid.set(p.uid, p));
      renderAll();

      // UI nur sperren, wenn wir wirklich in DIESEM Raum sind
      const me = playersByUid.get(UID);
      if (me && state.code && state.code === (localStorage.getItem('qp_room') || '')) {
        joinedOnce = true;
        setJoinUI(true);
      } else {
        setJoinUI(false);
      }
    });

    // Teil-Update: Spieler
    socket.on('players:update', (msg) => {
      if ((msg.version ?? -1) <= lastVersion) return;
      lastVersion = msg.version ?? -1;

      (msg.players || []).forEach(p => playersByUid.set(p.uid, p));
      renderAll();
    });

    // Neue Frage
    socket.on('question:show', (q) => {
      if ((q.version ?? -1) <= lastVersion) return;
      lastVersion = q.version ?? -1;
      $('#question').textContent = q.text || 'â€“';
    });

    // Status-Meldungen
    socket.on('status', (t) => {
      $('#pStatus').textContent = t;
      setTimeout(()=>$('#pStatus').textContent='', 1500);
    });

    // Sauber abmelden beim Tab-SchlieÃŸen (optional)
    window.addEventListener('beforeunload', () => {
      // kein explizites leave nÃ¶tig â€“ Server markiert beim disconnect offline
    });
  </script>
</body>
</html>
