<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker ‚Äì Admin</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* Runde Tisch-Ansicht wie bei player.html */
    :root { --ring: 460px; --seat: 96px; }
    .table-wrap { display:flex; justify-content:center; }
    .table-circle {
      position:relative; width:var(--ring); height:var(--ring);
      margin:10px auto; border-radius:50%;
      background: radial-gradient(closest-side, #11213a 0%, #0d172a 60%, #0b1220 100%);
      box-shadow: 0 0 0 2px #1d2636 inset, 0 10px 30px rgba(0,0,0,.5);
    }
    .seat {
      position:absolute; width:var(--seat); height:var(--seat);
      border-radius:14px; border:1px solid #26324a; background:#0b1220;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px; padding:8px; text-align:center;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    .seat .avatar {
      width:48px; height:48px; border-radius:50%; background:#141a2a;
      display:flex; align-items:center; justify-content:center; border:1px solid #283552;
      font-weight:700; overflow:hidden;
    }
    .seat .name { font-size:13px; line-height:1.2; }
    .seat .chips { font-size:12px; opacity:.9; }
    .seat.disconnected { opacity:.5; filter:saturate(.5); }
    /* Sitzpositionen (0 oben, dann im Uhrzeigersinn) */
    .s0 { left:50%; top:7%; }
    .s1 { left:82%; top:20%; }
    .s2 { left:93%; top:50%; }
    .s3 { left:82%; top:80%; }
    .s4 { left:50%; top:93%; }
    .s5 { left:18%; top:80%; }
    .s6 { left:7%;  top:50%; }
    .s7 { left:18%; top:20%; }
    /* Center */
    #table-center2 {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      padding:10px 14px; border-radius:12px; border:1px solid #2a3650; background:#0f1420;
      text-align:center; font-size:14px;
    }

    @media (max-width: 560px) {
      :root { --ring: 320px; --seat: 84px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h3 class="h">Raum</h3>
      <div class="list">
        <div class="item">
          <div>Code: <strong id="roomCode">‚Äî</strong></div>
          <div class="small">Frage: <span id="qIndex">‚Äì</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnCreate" class="primary">Raum erstellen</button>
        <button id="btnNextQ">‚û°Ô∏è N√§chste Frage</button>
      </div>

      <div class="status" style="margin-top:12px;">
        <div>Small Blind: <input id="inpSB" placeholder="Name" style="width:100%;margin-top:6px;"></div>
        <div>Big Blind: <input id="inpBB" placeholder="Name" style="width:100%;margin-top:6px;"></div>
        <button id="btnSetBlinds" style="margin-top:6px;">Blinds setzen</button>
      </div>

      <div class="status" id="adminStatus"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSyncAll">üîÑ Alle synchronisieren</button>
      </div>
    </aside>

    <main class="main">
      <h3 class="h">Frage</h3>
      <div id="questionBox" class="status" style="font-size:16px;">‚Äì</div>

      <div class="row" style="margin-top:10px;">
        <label style="display:flex; gap:6px; align-items:center;">
          UID: <input id="uidTarget" placeholder="Spieler-UID" style="width:240px;">
        </label>
        <label style="display:flex; gap:6px; align-items:center;">
          Œî Chips: <input id="deltaChips" type="number" value="10" style="width:120px;">
        </label>
        <button id="btnMarkCorrect" class="ok">‚úÖ Korrekt</button>
        <button id="btnMarkWrong"  class="err">‚ùå Falsch</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnMinus" class="err">‚àí Manuell</button>
        <button id="btnPlus"  class="ok">+ Manuell</button>
      </div>

      <div class="status" id="status"></div>

      <h3 class="h" style="margin-top:16px;">Antworten (live)</h3>
      <div id="answers" class="list" style="max-height:240px;overflow:auto;"></div>
    </main>

    <aside class="right">
      <h3 class="h">Spieler & Chips</h3>
      <div id="players" class="score"></div>

      <h3 class="h" style="margin-top:12px;">Tisch</h3>
      <div class="table-wrap">
        <div class="table-circle" id="table">
          <!-- feste 8 Pl√§tze -->
          <div class="seat s0" data-seat="0" title="Sitz 1"></div>
          <div class="seat s1" data-seat="1" title="Sitz 2"></div>
          <div class="seat s2" data-seat="2" title="Sitz 3"></div>
          <div class="seat s3" data-seat="3" title="Sitz 4"></div>
          <div class="seat s4" data-seat="4" title="Sitz 5"></div>
          <div class="seat s5" data-seat="5" title="Sitz 6"></div>
          <div class="seat s6" data-seat="6" title="Sitz 7"></div>
          <div class="seat s7" data-seat="7" title="Sitz 8"></div>
          <div id="table-center2">üí∞ Pot: <strong id="pot">0</strong></div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    const socket = io();

    const el   = (s) => document.querySelector(s);
    const playersList = el('#players');
    const answersList = el('#answers');

    // State
    let lastVersion = 0;
    const playersMap = new Map(); // uid -> {uid,name,chips,connected,seat}

    // UI: Buttons
    el('#btnCreate').onclick    = () => socket.emit('mod:create-room');
    el('#btnNextQ').onclick     = () => socket.emit('mod:next-question');
    el('#btnSetBlinds').onclick = () => socket.emit('mod:set-blinds', { small: el('#inpSB').value.trim(), big: el('#inpBB').value.trim() });
    el('#btnSyncAll').onclick   = () => socket.emit('mod:sync-all');

    el('#btnMarkCorrect').onclick = () => {
      const uid = el('#uidTarget').value.trim(); if (!uid) return;
      const delta = parseInt(el('#deltaChips').value || '0', 10) || 0;
      socket.emit('mod:mark', { uid, result: 'correct', delta });
    };
    el('#btnMarkWrong').onclick = () => {
      const uid = el('#uidTarget').value.trim(); if (!uid) return;
      const delta = parseInt(el('#deltaChips').value || '0', 10) || 0;
      socket.emit('mod:mark', { uid, result: 'wrong', delta: -Math.abs(delta) });
    };

    el('#btnPlus').onclick = () => {
      const uid = el('#uidTarget').value.trim(); if (!uid) return;
      const delta = Math.abs(parseInt(el('#deltaChips').value || '0', 10) || 0);
      socket.emit('mod:adjust', { uid, delta });
    };
    el('#btnMinus').onclick = () => {
      const uid = el('#uidTarget').value.trim(); if (!uid) return;
      const delta = -Math.abs(parseInt(el('#deltaChips').value || '0', 10) || 0);
      socket.emit('mod:adjust', { uid, delta });
    };

    // Rendering: Score-Liste
    function renderPlayersPanel() {
      const arr = Array.from(playersMap.values()).sort((a,b) => (a.seat ?? 99) - (b.seat ?? 99));
      playersList.innerHTML = '';
      arr.forEach(p => {
        const div = document.createElement('div');
        div.className = 'player';
        div.innerHTML = `
          <span title="UID: ${p.uid}">${p.name} ${p.connected? 'üü¢':'üî¥'}</span>
          <strong>${p.chips || 0}</strong>
          <div class="pm">
            <button class="score-btn" data-uid="${p.uid}" data-d="+10">+10</button>
            <button class="score-btn" data-uid="${p.uid}" data-d="-10">-10</button>
          </div>`;
        // Bei Klick auf den Namen ‚Üí UID ins Ziel √ºbernehmen
        div.querySelector('span').addEventListener('click', () => {
          el('#uidTarget').value = p.uid;
        });
        playersList.appendChild(div);
      });
    }

    // Rendering: Feste Sitze 0..7 im Kreis
    function renderSeats() {
      // leeren/belegen
      for (let i = 0; i < 8; i++) {
        const slot = document.querySelector(`.seat[data-seat="${i}"]`);
        if (!slot) continue;
        slot.className = `seat s${i}`;
        slot.innerHTML = `
          <div class="avatar">‚Äî</div>
          <div class="name">Frei</div>
          <div class="chips">ü™ô 0</div>
        `;
        slot.onclick = null;
        slot.dataset.uid = '';
      }
      // Spieler einsetzen
      for (const p of playersMap.values()) {
        const si = (typeof p.seat === 'number') ? p.seat : null;
        if (si === null || si < 0 || si > 7) continue;
        const slot = document.querySelector(`.seat[data-seat="${si}"]`);
        if (!slot) continue;
        slot.innerHTML = `
          <div class="avatar">${(p.avatar && p.avatar.startsWith?.('http')) ? `<img src="${p.avatar}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : 'üôÇ'}</div>
          <div class="name">${p.name}</div>
          <div class="chips">ü™ô ${p.chips ?? 0}</div>
        `;
        if (!p.connected) slot.classList.add('disconnected');
        slot.dataset.uid = p.uid;
        // Klick auf Sitz ‚Üí UID ins Feld √ºbernehmen (schnell markieren)
        slot.onclick = () => { el('#uidTarget').value = p.uid; };
      }
    }

    function renderAll(stateLike = null) {
      if (stateLike && typeof stateLike.pot === 'number') {
        el('#pot').textContent = stateLike.pot;
      }
      renderPlayersPanel();
      renderSeats();
    }

    // Click-Handler f√ºr +10/-10 im Score-Panel
    playersList.addEventListener('click', (e) => {
      const btn = e.target.closest('.score-btn');
      if (!btn) return;
      const uid   = btn.dataset.uid;
      const delta = parseInt(btn.dataset.d, 10);
      el('#uidTarget').value = uid;
      socket.emit('mod:adjust', { uid, delta });
    });

    // Socket Events
    socket.on('mod:room-created', ({ code, state }) => {
      el('#roomCode').textContent = code;
      lastVersion = 0;
      playersMap.clear();
      (state.players || []).forEach(p => playersMap.set(p.uid, p));
      el('#qIndex').textContent = state.qIndex >= 0 ? (state.qIndex + 1) : '‚Äì';
      el('#questionBox').textContent = state.question?.text || '‚Äì';
      renderAll(state);
    });

    socket.on('state:full', (state) => {
      if ((state.version ?? 0) <= lastVersion) return;
      lastVersion = state.version ?? 0;
      playersMap.clear();
      (state.players || []).forEach(p => playersMap.set(p.uid, p));
      el('#qIndex').textContent = state.qIndex >= 0 ? (state.qIndex + 1) : '‚Äì';
      el('#questionBox').textContent = state.question?.text || '‚Äì';
      renderAll(state);
    });

    socket.on('state:partial', (msg) => {
      if ((msg.version ?? 0) <= lastVersion) return;
      lastVersion = msg.version ?? 0;
      // z. B. blinds, pot etc. ‚Äì wenn du sp√§ter partielle Felder nachr√ºstest
      if (typeof msg.pot === 'number') el('#pot').textContent = msg.pot;
    });

    socket.on('players:update', (msg) => {
      if ((msg.version ?? 0) <= lastVersion) return;
      lastVersion = msg.version ?? 0;
      (msg.players || []).forEach(p => playersMap.set(p.uid, p));
      renderAll();
    });

    socket.on('question:show', (q) => {
      if ((q.version ?? 0) <= lastVersion) return;
      lastVersion = q.version ?? 0;
      el('#qIndex').textContent = (q.index + 1);
      el('#questionBox').textContent = q.text || '‚Äì';
      el('#answers').innerHTML = '';
    });

    socket.on('answer:received', ({ uid, name, answer }) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.textContent = `${name}: ${answer}`;
      answersList.prepend(div);
      el('#uidTarget').value = uid; // Schnellmarkierung m√∂glich
    });

    socket.on('result:correct', ({ name, delta }) => {
      const s = el('#status');
      s.textContent = `‚úÖ ${name} +${Math.abs(delta||0)} Chips`;
      setTimeout(() => s.textContent = '', 1500);
    });
    socket.on('result:wrong', ({ name, delta }) => {
      const s = el('#status');
      s.textContent = `‚ùå ${name} ${delta||0} Chips`;
      setTimeout(() => s.textContent = '', 1500);
    });

    socket.on('status', (t) => { el('#adminStatus').textContent = t; });
  </script>
</body>
</html>
