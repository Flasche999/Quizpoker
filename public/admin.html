<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker â€“ Admin</title>
  <link rel="stylesheet" href="/style.css?v=5" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{--bg:#0e0f12;--card:#151821;--line:#262b36;--ok:#2a5e3b;--err:#5b2730;--pri:#1363ff}
    body{background:var(--bg);color:#e7e9ee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    .layout{display:grid;grid-template-columns:320px 1fr 360px;gap:12px;padding:12px}
    .sidebar,.main,.right{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .h{margin:0 0 8px;font-size:16px}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid var(--line);border-radius:10px;padding:8px;background:#0f1118}
    .row{display:flex;gap:8px;align-items:center}
    .row > input, .row > button, .row > select, .row > textarea{border:1px solid var(--line);background:#0f1118;color:#e7e9ee;border-radius:8px;padding:8px}
    .row > button{cursor:pointer}
    .row > button.primary{background:#0f1627;border-color:#1e3a8a}
    .row > button.ok{border-color:var(--ok)}
    .row > button.err{border-color:var(--err)}
    .status{border:1px dashed var(--line);border-radius:10px;padding:8px}
    .small{font-size:12px;opacity:.85}
    .muted{opacity:.7}
    .score .player{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:10px;padding:8px;margin-bottom:8px;background:#0f1118}
    .score .player.turn{border:3px solid gold!important;box-shadow:0 0 10px rgba(255,215,0,.7)}
    .score .player.folded{opacity:.55;filter:saturate(.6)}
    .betline{font-size:12px;opacity:.9}
    .badge{display:inline-block;font-weight:700;color:#000;background:#fff;border-radius:50%;width:20px;height:20px;line-height:20px;text-align:center;margin-left:6px;font-size:12px}
    .badge-s{border:2px solid #1363ff}
    .badge-b{border:2px solid #ff2b2b}
    .table-wrap{position:relative;height:280px}
    .table-circle{position:relative;width:100%;height:100%;border:1px solid var(--line);border-radius:16px;display:grid;place-items:center;background:#0f1118}
    .seat{position:absolute;width:120px;background:#10131b;border:1px solid var(--line);border-radius:10px;padding:6px}
    .seat .name{font-size:13px;margin-top:4px}
    .seat .chips,.seat .betline{font-size:12px;opacity:.9}
    .seat.folded{opacity:.55}
    .seat.turn{border:3px solid gold!important;box-shadow:0 0 10px rgba(255,215,0,.7)}
    .s0{top:8px;left:calc(50% - 60px)}
    .s1{top:36px;right:8px}
    .s2{top:calc(50% - 60px);right:8px}
    .s3{bottom:36px;right:8px}
    .s4{bottom:8px;left:calc(50% - 60px)}
    .s5{bottom:36px;left:8px}
    .s6{top:calc(50% - 60px);left:8px}
    .s7{top:36px;left:8px}
    #table-center2{font-weight:700}
    .chatlog{height:220px;overflow:auto;border:1px solid var(--line);border-radius:10px;background:#0f1118;padding:8px}
    .chatrow{margin-bottom:6px}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
    .pill.admin{background:#3b2a5e}
    .pill.player{background:#283046}
    .pill.me{background:#2a5e3b}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h3 class="h">Raum</h3>
      <div class="list">
        <div class="item">
          <div>Code: <strong id="roomCode">â€”</strong></div>
          <div class="small">Frage: <span id="qIndex">â€“</span></div>
          <div class="small">Runde: <strong id="roundIdx">0</strong> Â· Aktionen: <strong id="acted">0</strong>/<strong id="need">0</strong></div>
          <div class="small">Aktuelle Bet (Runde): <strong id="currentBet">0</strong></div>
          <div class="small">Pot: <strong id="pot">0</strong></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button id="btnCreate" class="primary">Raum erstellen</button>
        <button id="btnNextQ">ğŸ†• Frage starten</button>
      </div>

      <div class="status" style="margin-top:12px;">
        <div>Small Blind (Seat #): <input id="inpSB" placeholder="0â€“7" style="width:100%;margin-top:6px;"></div>
        <div>Big Blind (Seat #): <input id="inpBB" placeholder="0â€“7" style="width:100%;margin-top:6px;"></div>
        <button id="btnSetBlinds" style="margin-top:6px;">Blinds setzen</button>
      </div>

      <div class="status" style="margin-top:12px;">
        <div class="row">
          <button id="btnRevealH1">ğŸ”“ Hinweis 1</button>
          <button id="btnRevealH2">ğŸ”“ Hinweis 2</button>
          <button id="btnRevealSol">ğŸ”“ LÃ¶sung</button>
        </div>
        <div class="small muted">Nur mÃ¶glich, wenn die jeweilige Aktionsrunde vollstÃ¤ndig ist.</div>
      </div>

      <div class="status" style="margin-top:12px;">
        <div class="row">
          <input id="inpTurnUid" placeholder="Turn: UID" style="flex:1;">
          <input id="inpTurnSeat" placeholder="Seat 0â€“7" style="width:120px;">
        </div>
        <div class="row" style="margin-top:6px;">
          <button id="btnSetTurn">Turn setzen</button>
          <button id="btnNextTurn">â­ï¸ NÃ¤chster Spieler</button>
          <button id="btnSkipFold" class="err">â³ Spieler Ã¼berspringen (Fold)</button>
        </div>
      </div>

      <!-- CHIPS MANAGEMENT -->
      <div class="status" style="margin-top:12px;">
        <div class="row">
          <input id="chipsSetAll" type="number" placeholder="Startchips (z. B. 1000)" style="flex:1;">
          <button id="btnChipsSetAll" class="ok">Allen setzen</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <input id="chipsDeltaAll" type="number" placeholder="+/âˆ’ fÃ¼r alle (z. B. 100)" style="flex:1;">
          <button id="btnChipsAddAll">Allen +/âˆ’</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <select id="chipsOneUid" style="flex:1;"><option value="">Spieler wÃ¤hlenâ€¦</option></select>
          <input id="chipsDeltaOne" type="number" placeholder="+/âˆ’ fÃ¼r einen" style="width:150px;">
          <button id="btnChipsAddOne">Einzeln +/âˆ’</button>
        </div>
      </div>

      <div class="status" style="margin-top:12px;">
        <div class="row">
          <input id="inpWinnerUid" placeholder="Gewinner-UID (manuell)" style="flex:1;">
          <button id="btnAwardPot" class="ok">ğŸ† Pot auszahlen</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <button id="btnAwardNearest">ğŸ† NÃ¤chstliegenden automatisch</button>
        </div>
      </div>

      <div class="status" id="adminStatus" style="margin-top:12px;"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSyncAll">ğŸ”„ Alle synchronisieren</button>
      </div>
    </aside>

    <main class="main">
      <h3 class="h">Frage & Hinweise</h3>
      <div class="list">
        <div class="item"><strong>Frage:</strong> <span id="qText">â€“</span></div>
        <div class="item"><strong>Hinweis 1:</strong> <span id="qH1" class="muted">verdeckt</span></div>
        <div class="item"><strong>Hinweis 2:</strong> <span id="qH2" class="muted">verdeckt</span></div>
        <div class="item"><strong>LÃ¶sung:</strong> <span id="qSol" class="muted">verdeckt</span></div>
      </div>

      <h3 class="h" style="margin-top:16px;">Private DMs</h3>
      <div class="item">
        <div class="row">
          <select id="dmSelect" style="flex:1;"><option value="">Spieler wÃ¤hlenâ€¦</option></select>
          <button id="btnDmClearOne" class="err">Diesen Chat lÃ¶schen</button>
          <button id="btnDmClearAll" class="err">Alle Chats lÃ¶schen</button>
        </div>
        <div class="chatlog" id="dmLog" style="margin-top:8px;"></div>
        <div class="row" style="margin-top:8px;">
          <input id="dmMessage" placeholder="Nachricht an Spielerâ€¦ (Enter sendet)" style="flex:1;">
          <button id="btnDmSend" class="primary">Senden</button>
        </div>
        <div class="small muted" style="margin-top:4px;">Hinweis: Der Verlauf ist pro Spieler. Auswahl oben Ã¤ndert den sichtbaren Thread.</div>
      </div>

      <h3 class="h" style="margin-top:16px;">Antworten (live)</h3>
      <div id="answers" class="list" style="max-height:160px;overflow:auto;"></div>
    </main>

    <aside class="right">
      <h3 class="h">Lobby â€“ Spieler</h3>
      <div id="players" class="score"></div>

      <h3 class="h" style="margin-top:12px;">Virtueller Tisch</h3>
      <div class="table-wrap">
        <div class="table-circle">
          <div class="seat s0" data-seat="0"></div>
          <div class="seat s1" data-seat="1"></div>
          <div class="seat s2" data-seat="2"></div>
          <div class="seat s3" data-seat="3"></div>
          <div class="seat s4" data-seat="4"></div>
          <div class="seat s5" data-seat="5"></div>
          <div class="seat s6" data-seat="6"></div>
          <div class="seat s7" data-seat="7"></div>
          <div id="table-center2">ğŸ’° Pot: <strong id="pot2">0</strong></div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    const socket = io({ path:'/socket.io', transports:['websocket','polling'] });
    const el = (s)=>document.querySelector(s);
    const state = { blinds:{small:null,big:null}, turnUid:null, roundIndex:0, chats:new Map(), players:[] };

    const emitOk = (evt, payload)=>{ if(!socket.connected){ el('#adminStatus').textContent='Nicht verbunden.'; return false; } socket.emit(evt,payload); return true; };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Connect / Restore â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('connect', ()=>{
      el('#adminStatus').textContent = 'Verbunden: '+socket.id;
      const last = localStorage.getItem('qp_admin_room'); if (last) socket.emit('mod:claim-room', { code:last });
    });
    socket.on('disconnect', ()=>{ el('#adminStatus').textContent='Getrennt.'; });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Buttons Grundfunktionen â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('#btnCreate').onclick=()=>emitOk('mod:create-room');
    el('#btnNextQ').onclick =()=>emitOk('mod:next-question');
    el('#btnSetBlinds').onclick = ()=>{
      const sb=el('#inpSB').value.trim(), bb=el('#inpBB').value.trim();
      emitOk('mod:set-blinds',{ small: sb===''?null:Number(sb), big: bb===''?null:Number(bb) });
    };
    el('#btnRevealH1').onclick=()=>emitOk('mod:reveal-hint1');
    el('#btnRevealH2').onclick=()=>emitOk('mod:reveal-hint2');
    el('#btnRevealSol').onclick=()=>emitOk('mod:reveal-solution');

    el('#btnSetTurn').onclick = ()=>{
      const uid=el('#inpTurnUid').value.trim(); const seatStr=el('#inpTurnSeat').value.trim();
      const seat = seatStr==='' ? undefined : Number(seatStr);
      emitOk('mod:set-turn',{ uid: uid || undefined, seat: Number.isInteger(seat)?seat:undefined });
    };
    el('#btnNextTurn').onclick = ()=>emitOk('mod:next-turn');
    el('#btnSkipFold').onclick = ()=>emitOk('mod:skip-fold');

    el('#btnAwardPot').onclick=()=>{
      const uid=el('#inpWinnerUid').value.trim(); if(!uid) return; emitOk('mod:award-pot',{ uid });
    };
    el('#btnAwardNearest').onclick=()=>emitOk('mod:award-nearest');
    el('#btnSyncAll').onclick=()=>emitOk('mod:sync-all');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Chips Management â”€â”€â”€â”€â”€â”€â”€â”€â”€
    el('#btnChipsSetAll').onclick=()=>{
      const amount = Number(el('#chipsSetAll').value || 0);
      emitOk('mod:chips-set-all', { amount });
    };
    el('#btnChipsAddAll').onclick=()=>{
      const delta = Number(el('#chipsDeltaAll').value || 0);
      emitOk('mod:chips-add-all', { delta });
    };
    el('#btnChipsAddOne').onclick=()=>{
      const uid = el('#chipsOneUid').value;
      const delta = Number(el('#chipsDeltaOne').value || 0);
      if (!uid) { el('#adminStatus').textContent='Bitte Spieler wÃ¤hlen.'; return; }
      emitOk('mod:chips-add-one', { uid, delta });
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ DMs â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const dmSelect = el('#dmSelect');
    const dmLog = el('#dmLog');
    function dmAppend(html){
      const d=document.createElement('div'); d.className='chatrow'; d.innerHTML=html;
      dmLog.appendChild(d); dmLog.scrollTop = dmLog.scrollHeight;
    }
    function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));}

    function renderDmFor(uid){
      dmLog.innerHTML='';
      const thread = state.chats.get(uid) || [];
      thread.forEach(t=>{
        const who = t.from==='admin' ? '<span class="pill admin">Admin</span>' : '<span class="pill player">Spieler</span>';
        dmAppend(`${who} ${new Date(t.ts).toLocaleTimeString()} â€” ${escapeHtml(t.message)}`);
      });
    }
    dmSelect.onchange = ()=>{ if(dmSelect.value) renderDmFor(dmSelect.value); };

    function ensureChat(uid){ if(!state.chats.has(uid)) state.chats.set(uid,[]); return state.chats.get(uid); }

    el('#btnDmSend').onclick = ()=>{
      const uid = dmSelect.value; const msg = el('#dmMessage').value.trim();
      if(!uid || !msg) return;
      emitOk('mod:dm', { uid, message: msg });
      // lokales Echo:
      const thr = ensureChat(uid);
      thr.push({ from:'admin', message:msg, ts:Date.now() });
      renderDmFor(uid);
      el('#dmMessage').value = '';
    };
    el('#dmMessage').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); el('#btnDmSend').click(); }});

    el('#btnDmClearOne').onclick = ()=>{ const uid = dmSelect.value; if(!uid) return; emitOk('mod:chat-clear-one', { uid }); };
    el('#btnDmClearAll').onclick = ()=>emitOk('mod:chat-clear-all');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Render Helfer â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function badge(p){
      const isSB = (p.seat === (state.blinds?.small ?? null));
      const isBB = (p.seat === (state.blinds?.big ?? null));
      return (isSB?'<span class="badge badge-s">S</span>':'') + (isBB?'<span class="badge badge-b">B</span>':'');
    }
    function refreshSelects(players){
      // DM-Select & Chips-Einzel-Select
      const keeps = new Set();
      const curDm = dmSelect.value;
      const curChip = el('#chipsOneUid').value;
      dmSelect.innerHTML = '<option value="">Spieler wÃ¤hlenâ€¦</option>';
      el('#chipsOneUid').innerHTML = '<option value="">Spieler wÃ¤hlenâ€¦</option>';
      players.forEach(p=>{
        const opt1=document.createElement('option'); opt1.value=p.uid; opt1.textContent=`${p.name} (${p.uid.slice(0,6)}â€¦)`;
        const opt2=opt1.cloneNode(true);
        dmSelect.appendChild(opt1);
        el('#chipsOneUid').appendChild(opt2);
        keeps.add(p.uid);
      });
      if (keeps.has(curDm)) dmSelect.value = curDm;
      if (keeps.has(curChip)) el('#chipsOneUid').value = curChip;
    }
    function renderTop(st){
      el('#roomCode').textContent = st.code || 'â€”';
      el('#qIndex').textContent = st.qIndex>=0 ? (st.qIndex+1) : 'â€“';
      el('#roundIdx').textContent = st.roundIndex||0;
      el('#acted').textContent = st.actedCount||0;
      el('#need').textContent = st.needCount||0;
      el('#currentBet').textContent = st.currentBetRound||0;
      el('#pot').textContent = st.pot||0;
      el('#pot2').textContent = st.pot||0;

      el('#qText').textContent = st.question?.text || 'â€“';
      el('#qH1').textContent   = st.question?.hint1 ?? 'verdeckt';
      el('#qH2').textContent   = st.question?.hint2 ?? 'verdeckt';
      el('#qSol').textContent  = st.question?.solution ?? 'verdeckt';

      state.blinds = st.blinds||{small:null,big:null};
      state.turnUid = st.turnUid || null;
      state.roundIndex = st.roundIndex||0;
    }
    function renderPlayers(st){
      state.players = (st.players||[]).slice();
      const wrap = el('#players'); wrap.innerHTML='';
      const arr = state.players.slice().sort((a,b)=>(a.seat??99)-(b.seat??99));
      arr.forEach(p=>{
        const div=document.createElement('div');
        div.className='player'+(p.uid===state.turnUid?' turn':'')+(p.status==='folded'?' folded':'');
        const est = (p.estimate===null || typeof p.estimate==='number') ? (p.estimate===null?'â€”':p.estimate) : 'â€”';
        div.innerHTML=`
          <div class="row" style="justify-content:space-between;">
            <span title="UID: ${p.uid}">${p.name} ${p.connected?'ğŸŸ¢':'ğŸ”´'} ${badge(p)}</span>
            <strong>ğŸª™ ${p.chips||0}</strong>
          </div>
          <div class="small betline">Runde: ğŸª™ ${p.betRound||0} Â· Gesamt: ğŸª™ ${p.betTotal||0} ${p.status==='allin'?' Â· (All-in)':''}${p.status==='folded'?' Â· (Fold)':''}</div>
          <div class="small">SchÃ¤tzwert: <strong>${est}</strong></div>
        `;
        wrap.appendChild(div);
      });
      refreshSelects(arr);
    }
    function renderSeats(st){
      for(let i=0;i<8;i++){
        const slot = document.querySelector(`.seat[data-seat="${i}"]`);
        if(!slot) continue;
        slot.className = `seat s${i}`;
        slot.innerHTML = '<div class="avatar">ğŸ™‚</div><div class="name">Frei</div><div class="chips">ğŸª™ 0</div><div class="betline">Runde: ğŸª™ 0 Â· Gesamt: ğŸª™ 0</div>';
      }
      (st.players||[]).forEach(p=>{
        if(typeof p.seat!=='number') return;
        const slot=document.querySelector(`.seat[data-seat="${p.seat}"]`); if(!slot) return;
        const est = (p.estimate===null || typeof p.estimate==='number') ? (p.estimate===null?'â€”':p.estimate) : 'â€”';
        slot.innerHTML = `<div class="avatar">ğŸ™‚</div>
          <div class="name">${p.name} ${badge(p)}</div>
          <div class="chips">ğŸª™ ${p.chips??0}</div>
          <div class="betline">Runde: ğŸª™ ${p.betRound||0} Â· Gesamt: ğŸª™ ${p.betTotal||0}</div>
          <div class="small">SchÃ¤tzwert: <strong>${est}</strong></div>`;
        if(!p.connected) slot.classList.add('disconnected');
        if(p.status==='folded') slot.classList.add('folded');
        if(p.uid===state.turnUid) slot.classList.add('turn');
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Socket Events vom Server â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('mod:room-created', ({ code, state:st })=>{
      localStorage.setItem('qp_admin_room', code);
      renderTop(st); renderPlayers(st); renderSeats(st);
      el('#adminStatus').textContent = 'Raum erstellt: '+code;
    });

    socket.on('state:full', (st)=>{ renderTop(st); renderPlayers(st); renderSeats(st); });
    socket.on('players:update', (msg)=>{ if(!msg?.players) return; renderPlayers({players:msg.players, blinds:state.blinds, turnUid:state.turnUid}); renderSeats({players:msg.players, blinds:state.blinds, turnUid:state.turnUid}); });
    socket.on('state:partial', (patch)=>{
      if (patch.blinds) state.blinds = patch.blinds;
      if ('turnUid' in patch) state.turnUid = patch.turnUid;
      if ('roundIndex' in patch) state.roundIndex = patch.roundIndex;
      if ('actedCount' in patch) el('#acted').textContent = patch.actedCount;
      if ('needCount' in patch) el('#need').textContent = patch.needCount;
      if ('currentBetRound' in patch) el('#currentBet').textContent = patch.currentBetRound;
      if ('pot' in patch) { el('#pot').textContent = patch.pot; el('#pot2').textContent = patch.pot; }
      if (patch.question) {
        el('#qText').textContent = patch.question?.text || 'â€“';
        el('#qH1').textContent   = patch.question?.hint1 ?? 'verdeckt';
        el('#qH2').textContent   = patch.question?.hint2 ?? 'verdeckt';
        el('#qSol').textContent  = patch.question?.solution ?? 'verdeckt';
      }
      socket.emit('mod:sync-all');
    });

    socket.on('question:show', (q)=>{
      el('#qIndex').textContent = (q.index+1);
      el('#qText').textContent = q.text || 'â€“';
      el('#qH1').textContent='verdeckt'; el('#qH2').textContent='verdeckt'; el('#qSol').textContent='verdeckt';
    });

    socket.on('answer:received', ({ uid, name, answer })=>{
      const div=document.createElement('div'); div.className='item'; div.textContent = `${name}: ${answer}`;
      el('#answers').prepend(div);
    });

    // DMs vom Server
    socket.on('dm:from-player', ({ uid, name, message, ts })=>{
      const thr = ensureChat(uid); thr.push({ from:'player', message, ts });
      if (dmSelect.value === uid) renderDmFor(uid);
    });
    socket.on('dm:sent', ({ uid, name, message, ts })=>{
      const thr = ensureChat(uid); thr.push({ from:'admin', message, ts });
      if (dmSelect.value === uid) renderDmFor(uid);
    });
    socket.on('dm:cleared-one', ({ uid })=>{
      state.chats.set(uid, []);
      if (dmSelect.value === uid) renderDmFor(uid);
    });
    socket.on('dm:cleared-all', ()=>{
      state.chats.clear(); dmLog.innerHTML='';
    });

    socket.on('status', (t)=>{ el('#adminStatus').textContent = t; });
  </script>
</body>
</html>
