<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker – Admin</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    /* UI-Controls – Tisch/Seats kommen aus /style.css */
    .tbl { width:100%; border-collapse:collapse; font-size:14px }
    .tbl th,.tbl td{ border:1px solid #2a2f3a; padding:6px 8px; text-align:left }
    .badge{ display:inline-block; padding:1px 6px; border-radius:6px; font-size:11px; border:1px solid #2a2f3a; margin-left:6px }
    .badge.sb{ background:#20324b }
    .badge.bb{ background:#4b2020 }
    .tiny{ font-size:12px; opacity:.8 }
    .controls .btn{ margin-right:6px; margin-top:6px }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.25) }
    .container{ max-width:1100px; margin:0 auto; padding:16px }
    .h{ margin:0 0 8px 0; font-weight:700; font-size:20px }
    .btn{ padding:10px 14px; border-radius:12px; border:1px solid #30374a; background:#141b2d; color:var(--text); cursor:pointer }
    .btn.ok{ border-color:#14532d; background:#0f2f1f }
    .btn.warn{ border-color:#7c2d12; background:#2b140f }
    .btn.bad{ border-color:#7f1d1d; background:#2b0f0f }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    input[type=number]{ width:120px }
    .w120{ width:120px }

    /* Sitz-Overlays */
    .turn { outline:3px solid var(--accent); box-shadow:0 0 0 6px rgba(124,58,237,.2), 0 0 24px rgba(124,58,237,.35); position:relative }
    .turn-pill{ position:absolute; left:50%; top:-10px; transform:translate(-50%,-100%); background:var(--accent); color:#fff; font-weight:700; font-size:11px; padding:3px 8px; border-radius:999px }
    .out { opacity:.6; filter:saturate(.4) }
    .out-pill{ position:absolute; left:8px; top:8px; background:#991b1b; color:#fff; font-size:11px; padding:2px 6px; border-radius:999px }
    .folded { opacity:.6 }
    .act-flag{ position:absolute; right:8px; top:8px; font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid #334155; background:#0b1324 }
    .act-flag.check{ background:#15311f; border-color:#1f4d2d }
    .act-flag.call{ background:#102a3a; border-color:#173e58 }
    .act-flag.raise{ background:#2b2341; border-color:#403469 }
    .act-flag.allin{ background:#4a1e1e; border-color:#6b2b2b; font-weight:700 }
    .act-flag.fold{ background:#3a1111; border-color:#5b1a1a; font-weight:700 }
    .guess-chip{ position:absolute; left:50%; bottom:-8px; transform:translate(-50%,100%); font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid #334155; background:#0b1324 }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="card" style="flex:2;min-width:520px">
        <h2 class="h">Runde steuern</h2>
        <div class="row controls">
          <div>
            <div class="tiny">Frage wählen</div>
            <select id="questionSelect" class="w120"></select>
          </div>
          <button class="btn ok" id="startRound">Runde starten</button>
          <button class="btn" id="lockGuesses">Schätzen sperren (weiter zu Bet1)</button>
          <button class="btn" id="revealHint1">Hinweis 1</button>
          <button class="btn" id="revealHint2">Hinweis 2</button>
          <button class="btn warn" id="goReveal">Lösung zeigen + Letzte Bet</button>
          <button class="btn ok" id="resolveWinner">Gewinner ermitteln</button>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <div class="tiny">Small Blind</div>
            <input class="input" id="sbVal" type="number" min="1" value="10" />
          </div>
          <div>
            <div class="tiny">Big Blind</div>
            <input class="input" id="bbVal" type="number" min="1" value="20" />
          </div>
          <button class="btn" id="setBlinds">Blinds setzen</button>
          <button class="btn" id="assignBlinds">SB/BB zuweisen (nach Dealer)</button>
          <label class="tiny" style="margin-left:10px"><input type="checkbox" id="revealAll"> Alle Schätzungen sichtbar (Playersicht)</label>
        </div>

        <p class="tiny" style="margin-top:6px">
          Ablauf: Start → Schätzen → Bet1 → Hinweis1/Bet2 → Hinweis2/Bet3 → <b>Lösung</b> → <b>Letzte Bet</b> → Showdown.
          Admin sieht Schätzungen immer im Klartext; Playersicht pro Spieler aufdeckbar.
        </p>

        <div id="questionBox" class="card" style="margin-top:8px">Keine Frage aktiv.</div>
      </div>

      <div class="card" style="flex:1;min-width:320px">
        <h2 class="h">Sounds</h2>
        <div class="row">
          <button class="btn" data-snd="buzzer">Buzzer</button>
          <button class="btn ok" data-snd="correct">Correct</button>
          <button class="btn bad" data-snd="wrong">Wrong</button>
        </div>

        <h2 class="h" style="margin-top:12px">Status</h2>
        <div id="status"></div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1;min-width:420px">
        <h2 class="h">Schätzungen (Admin – immer Klartext)</h2>
        <div class="row" style="align-items:center; margin-bottom:6px">
          <button class="btn" id="refreshGuesses">Guesses neu laden</button>
          <span class="tiny">Wird außerdem nach jedem State automatisch aktualisiert.</span>
        </div>
        <table class="tbl" id="guessTable">
          <thead><tr><th>Spieler</th><th>Schätzung</th><th>Playersicht sichtbar</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="flex:1;min-width:420px">
        <h2 class="h">Chips & Rebuy (Admin)</h2>
        <table class="tbl" id="chipTable">
          <thead><tr><th>Spieler</th><th>Chips</th><th>Aktionen</th></tr></thead>
          <tbody></tbody>
        </table>

        <div class="row" style="margin-top:10px; align-items:center">
          <div>
            <div class="tiny">Massen-Chips</div>
            <input class="input" id="allChipsVal" type="number" value="10000" min="0" />
          </div>
          <button class="btn ok" id="setAllChips">Allen auf Betrag setzen</button>
          <button class="btn" id="addAllChips">Allen +Betrag geben</button>
          <div class="tiny">Setzen = exakt, +Betrag = additiv.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="h">KI-Testspieler</h2>
      <div class="row">
        <input class="input" id="botName" placeholder="Name (optional)" style="width:220px" />
        <button class="btn" id="addBot">Bot hinzufügen</button>
        <button class="btn" id="addBot3">+3 Bots</button>
        <button class="btn bad" id="removeBots">Alle Bots entfernen</button>
        <span class="tiny">Bots schätzen automatisch und spielen Bet-Phasen.</span>
      </div>
    </div>

    <div class="card">
      <h2 class="h">Virtueller Tisch</h2>
      <div class="table-wrap">
        <div class="table"></div>
        <div id="dealer" class="dealer" style="display:none">D</div>
        <div id="seats"></div>
        <div class="pot">Pot: <span id="pot">0</span></div>
      </div>
    </div>
  </div>

<script>
/* ──────────────────────────────────────────────────────────
   Sockets: Admin-Namespace + Default-Namespace (Dual-Wiring)
   ────────────────────────────────────────────────────────── */
const adminSock  = io('/admin'); // Admin-NS
const clientSock = io();         // Default-NS

// Beim Default-NS auch dem Admin-Room beitreten (für Server, der ADMIN_ROOM nutzt)
clientSock.on('connect', ()=> {
  clientSock.emit('joinAdmin'); // erhält sofort state + admin:guesses vom Server
});

// Nach Connect im Admin-NS initiale Guesses ziehen (Snapshot)
adminSock.on('connect', ()=> {
  // NEU: beide Events schicken → kompatibel zu 'admin:getGuesses' & 'admin:requestGuesses'
  adminSock.emit('admin:getGuesses');
  adminSock.emit('admin:requestGuesses');
});

// Helper: gleichzeitig auf BEIDEN Kanälen senden → maximale Kompatibilität
function emitAdmin(event, payload){
  try { adminSock.emit(event, payload); } catch(e){}
  try { clientSock.emit(event, payload); } catch(e){}
}

/* ──────────────────────────────────────────────────────────
   Utils & Rendering
   ────────────────────────────────────────────────────────── */
let GLOBAL_STATE = null;
function el(id){ return document.getElementById(id); }
function h(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstElementChild; }
function fmt(n){ return Number(n||0).toString(); }

// Fragen-Dropdown befüllen
(async function fillQuestions(){
  const sel = el('questionSelect'); sel.innerHTML='';
  try{
    const res = await fetch('/fragen.json'); const data = await res.json();
    data.forEach(item=>{
      const o = document.createElement('option');
      o.value = item.id; o.textContent = `${item.id} – ${item.frage?.slice(0,60) || 'Frage'}`;
      sel.appendChild(o);
    });
    if (!data.length){
      const o = document.createElement('option');
      o.value = 1; o.textContent = '1 – (Backup) Wie viele Minuten hat ein Tag?';
      sel.appendChild(o);
    }
  }catch{
    for(let i=0;i<50;i++){
      const o = document.createElement('option');
      o.value = i+1; o.textContent = 'Frage '+(i+1);
      sel.appendChild(o);
    }
  }
})();

// Sounds
function playSound(key){
  const m = { buzzer:'/sounds/buzzer.mp3', correct:'/sounds/correct.mp3', wrong:'/sounds/wrong.mp3' };
  const src = m[key]; if(src){ const a=new Audio(src); a.play().catch(()=>{}); }
}
adminSock.on('sound', ({key})=> playSound(key));
clientSock.on('sound', ({key})=> playSound(key)); // Fallback

// Action-Flag am Sitz
function showActionFlag(seatEl, type, amount){
  if (!seatEl) return;
  seatEl.querySelectorAll('.act-flag').forEach(n=>n.remove());
  const label = type==='raise' ? `Raise ${amount??''}` :
                type==='allin' ? 'All-In' :
                type==='call'  ? 'Call' :
                type==='check' ? 'Check' :
                type==='fold'  ? 'Fold'  : type;
  const flag = h(`<div class="act-flag ${type}">${label}</div>`);
  seatEl.appendChild(flag);
  if (type === 'fold') seatEl.classList.add('folded');
}

function renderState(st){
  GLOBAL_STATE = st;
  const q = st.round?.question;
  el('questionBox').innerHTML = q ? `
    <div><b>Frage:</b> ${q.frage}</div>
    <div><b>Hinweis 1:</b> ${q.hinweis1 ?? '—'}</div>
    <div><b>Hinweis 2:</b> ${q.hinweis2 ?? '—'}</div>
    <div><b>Lösung:</b> ${q.loesung ?? '—'}</div>
  ` : 'Keine Frage aktiv.';

  el('status').innerHTML = `
    <div>Phase: <b>${st.round.phase}</b></div>
    <div>Pot: <b>${fmt(st.table.pot)}</b> | Current Bet: <b>${fmt(st.table.currentBet)}</b> | Min Raise: <b>${fmt(st.table.minRaise)}</b></div>
    <div>Hinweise aufgedeckt: <b>${st.round.hintsRevealed || 0}</b></div>
    <div>Spieler: ${Object.values(st.players).map(p=>{
      const role = p.role ? (p.role==='SB' ? 'S' : 'B') : '';
      return `${p.name}${role? ' ['+role+']':''}${p.hasGuessed?' ✅':''}`;
    }).join(', ')}</div>
  `;

  el('sbVal').value = st.table.smallBlind ?? el('sbVal').value;
  el('bbVal').value = st.table.bigBlind ?? el('bbVal').value;

  // Seats – Slots 2 & 6 bleiben leer
  const seatsWrap = el('seats'); seatsWrap.innerHTML='';
  st.seats.forEach((sid,i)=>{
    const p = sid ? st.players[sid] : null;
    const seat = h(`<div class="seat s${i}"></div>`);
    if (p){
      const roleBadge = p.role ? `<span class="badge ${p.role==='SB'?'sb':'bb'}">${p.role==='SB'?'S':'B'}</span>` : '';
      seat.innerHTML = `
        ${p.avatar?`<img src="${p.avatar}" alt="avatar"/>`:`<img src="https://api.dicebear.com/7.x/thumbs/svg?seed=${encodeURIComponent(p.name)}" alt="avatar"/>`}
        <div class="name">${p.name} <span class="badge">Sitz ${i}</span> ${roleBadge}</div>
        <div class="chips">${fmt(p.chips)} Chips</div>
        <div class="tiny">Committed: ${fmt(p.committed||0)}</div>
      `;
      if(st.table.actingSeat === p.seat){
        seat.classList.add('turn');
        if(!seat.querySelector('.turn-pill')) seat.appendChild(h('<div class="turn-pill">DRAN</div>'));
      }
      if (p.isOut) {
        seat.classList.add('out');
        if(!seat.querySelector('.out-pill')) seat.appendChild(h('<div class="out-pill">OUT</div>'));
      }
      if (p.lastAction?.type === 'fold') seat.classList.add('folded');
      if (p.lastAction) showActionFlag(seat, p.lastAction.type, p.lastAction.amount);
    } else {
      seat.innerHTML = `<div class="name">(frei)</div><div class="chips">—</div>`;
    }
    seatsWrap.appendChild(seat);
  });

  // Dealer
  const dealer = el('dealer'); dealer.style.display='none';
  const dSeat = st.table.dealerSeat;
  const dEl = seatsWrap.querySelector('.seat.s'+dSeat);
  if(dEl){
    dealer.style.display='block';
    dealer.style.left = (dEl.offsetLeft + 8) + 'px';
    dealer.style.top  = (dEl.offsetTop - 12) + 'px';
  }

  // Pot
  el('pot').textContent = fmt(st.table.pot);

  // NEU: Nach jedem State aktiv die Guesses nachladen (beide Events)
  emitAdmin('admin:getGuesses');
  emitAdmin('admin:requestGuesses');
}

// Admin sieht Guesses (Klartext) + pro Spieler Reveal-Schalter (Playersicht)
function renderAdminGuesses(rows){
  const tb = el('guessTable').querySelector('tbody');
  tb.innerHTML = '';

  // Vor dem Rendern alle bestehenden Guess-Badges an Sitzen entfernen
  const seatsWrap = el('seats');
  seatsWrap.querySelectorAll('.guess-chip').forEach(n=>n.remove());

  (rows || []).forEach(r=>{
    const tr = h(`<tr>
      <td>${r.name}</td>
      <td><b>${r.value}</b></td>
      <td style="text-align:center"><input type="checkbox" ${r.revealed?'checked':''} data-sid="${r.sid}" /></td>
    </tr>`);
    tr.querySelector('input[type=checkbox]').onchange = (e)=>{
      emitAdmin('admin:revealGuess', { sid: e.target.dataset.sid, reveal: e.target.checked });
    };
    tb.appendChild(tr);

    // Sitz-Overlay „Guess: Wert“ (nicht zensiert im Admin)
    const st = GLOBAL_STATE; if (!st) return;
    const p = st.players?.[r.sid]; if (!p) return;
    const seatEl = el('seats').querySelector('.seat.s'+p.seat);
    if (seatEl){
      const chip = h(`<div class="guess-chip">Guess: ${r.value}</div>`);
      seatEl.appendChild(chip);
    }
  });

  // Button-Loading resetten
  resetRefreshBtn();
}

// Chips/ Rebuy Tabelle
function renderChipTable(st){
  const tb = el('chipTable').querySelector('tbody');
  tb.innerHTML = '';
  Object.values(st.players).forEach(p=>{
    const tr = h(`<tr>
      <td>${p.name}${p.isBot?' (Bot)':''}</td>
      <td>${fmt(p.chips)}</td>
      <td>
        <button class="btn" data-act="add" data-sid="${p.id}" data-d="50">+50</button>
        <button class="btn" data-act="add" data-sid="${p.id}" data-d="100">+100</button>
        <button class="btn" data-act="add" data-sid="${p.id}" data-d="500">+500</button>
        <button class="btn" data-act="add" data-sid="${p.id}" data-d="-50">-50</button>
        <button class="btn" data-act="custom" data-sid="${p.id}">+Custom</button>
        <button class="btn" data-act="rb"  data-sid="${p.id}">Rebuy</button>
      </td>
    </tr>`);
    tr.querySelectorAll('button').forEach(b=>{
      b.onclick = ()=>{
        const sid = b.dataset.sid;
        if (b.dataset.act === 'add'){
          emitAdmin('admin:adjustChips', { sid, delta: Number(b.dataset.d) });
        } else if (b.dataset.act === 'custom'){
          const amt = prompt('Chips (+/-) eingeben:','100');
          const delta = Number(amt);
          if (Number.isFinite(delta) && delta!==0){
            emitAdmin('admin:adjustChips', { sid, delta });
          }
        } else if (b.dataset.act === 'rb'){
          const amt = prompt('Rebuy-Betrag eingeben (leer = Standard):','');
          const amount = amt === '' ? undefined : Number(amt);
          emitAdmin('admin:rebuy', { sid, amount });
        }
      };
    });
    tb.appendChild(tr);
  });
}

// Verdrahten
function onState(st){ renderState(st); renderChipTable(st); }
adminSock.on('state', onState);
clientSock.on('state', renderState); // Fallback

// >>> Admin-Guesses: auf BEIDEN Sockets hören
function onAdminGuesses(rows){
  console.log('[admin:guesses]', rows);
  renderAdminGuesses(Array.isArray(rows) ? rows : []);
}
adminSock.on('admin:guesses', onAdminGuesses);
clientSock.on('admin:guesses', onAdminGuesses); // Fallback

// Fehlerkanal für Guesses
function onGuessesError(msg){
  console.warn('Guesses-Fehler:', msg);
  resetRefreshBtn();
  const tb = el('guessTable').querySelector('tbody');
  const tr = h(`<tr><td colspan="3" style="color:#e66">${msg || 'Konnte Schätzungen nicht Laden.'}</td></tr>`);
  tb.appendChild(tr);
}
adminSock.on('error:guesses', onGuessesError);
clientSock.on('error:guesses', onGuessesError);

// Gewinner Popup (unterstützt winnerSids für Split-Pot)
function onWinner({ winnerSid, solution, winnerSids }){
  if (Array.isArray(winnerSids) && winnerSids.length > 1) {
    const names = winnerSids.map(sid => GLOBAL_STATE?.players?.[sid]?.name || '—').join(', ');
    alert(`Split-Pot! Gewinner: ${names} (Lösung: ${solution})`);
  } else {
    const p = GLOBAL_STATE?.players?.[winnerSid];
    alert(`Gewinner: ${p?.name || '—'} (Lösung: ${solution})`);
  }
}
adminSock.on('winner', onWinner);
clientSock.on('winner', onWinner); // Fallback

// Live-Action-Flags
function onActionInfo({sid, type, amount}){
  const st = GLOBAL_STATE; if(!st) return;
  const p = st.players?.[sid]; if(!p) return;
  const seatEl = el('seats').querySelector('.seat.s'+p.seat);
  showActionFlag(seatEl, type, amount);
}
adminSock.on('actionInfo', onActionInfo);
clientSock.on('actionInfo', onActionInfo); // Fallback

// Buttons – Rundensteuerung
document.querySelectorAll('[data-snd]').forEach(b=> b.onclick=()=> emitAdmin('playSound', { key: b.dataset.snd }));
el('startRound').onclick   = ()=> emitAdmin('startRound', { questionId: el('questionSelect').value });
el('lockGuesses').onclick  = ()=> emitAdmin('admin:lockGuesses');
el('revealHint1').onclick  = ()=> emitAdmin('revealHint', 1);
el('revealHint2').onclick  = ()=> emitAdmin('revealHint', 2);
el('goReveal').onclick     = ()=> emitAdmin('goReveal');
el('resolveWinner').onclick= ()=> emitAdmin('resolveWinner');

el('setBlinds').onclick    = ()=> emitAdmin('admin:setBlinds', { small:Number(el('sbVal').value), big:Number(el('bbVal').value) });
el('assignBlinds').onclick = ()=> emitAdmin('admin:assignBlinds');

el('revealAll').onchange   = (e)=> emitAdmin('admin:revealAllGuesses', { reveal: e.target.checked });

// NEU: Guesses-Refresh Button mit Loading-State + Dual-Event
const refreshBtn = el('refreshGuesses');
function resetRefreshBtn(){
  if (!refreshBtn) return;
  refreshBtn.disabled = false;
  refreshBtn.textContent = 'Guesses neu laden';
}
refreshBtn.onclick = ()=> {
  refreshBtn.disabled = true;
  refreshBtn.textContent = 'Lade…';
  emitAdmin('admin:getGuesses');
  emitAdmin('admin:requestGuesses');
  // Safety-Timeout, falls keine Antwort zurückkommt
  setTimeout(()=> resetRefreshBtn(), 2500);
};

// NEU: Massen-Chips Buttons
el('setAllChips').onclick = ()=>{
  const v = Number(el('allChipsVal').value);
  if (!Number.isFinite(v) || v < 0) return alert('Bitte gültigen Betrag eingeben (≥ 0).');
  if (!confirm(`Wirklich ALLEN Spielern genau ${v} Chips setzen?`)) return;
  emitAdmin('admin:setAllChips', { amount: v });
};
el('addAllChips').onclick = ()=>{
  const v = Number(el('allChipsVal').value);
  if (!Number.isFinite(v)) return alert('Bitte gültigen Betrag eingeben.');
  emitAdmin('admin:addChipsAll', { delta: v });
};

// KI-Buttons
el('addBot').onclick = ()=>{
  const name = (el('botName').value||'').trim() || undefined;
  emitAdmin('admin:addBot', { name });
};
el('addBot3').onclick = ()=>{
  const base = (el('botName').value||'Bot').trim() || 'Bot';
  for(let i=1;i<=3;i++){
    emitAdmin('admin:addBot', { name: `${base} ${i}` });
  }
};
el('removeBots').onclick = ()=>{
  if (!confirm('Wirklich alle Bots entfernen?')) return;
  emitAdmin('admin:removeAllBots');
};
</script>
</body>
</html>
