<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker – Admin</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="card" style="flex:2">
        <h2 class="h">Runde steuern</h2>
        <div class="row">
          <div>
            <div class="small">Frage wählen</div>
            <select id="questionSelect"></select>
          </div>
          <button class="btn ok" id="startRound">Runde starten</button>
          <button class="btn" id="revealHint1">Hinweis 1</button>
          <button class="btn" id="revealHint2">Hinweis 2</button>
          <button class="btn warn" id="goReveal">Lösung zeigen</button>
          <button class="btn ok" id="resolveWinner">Gewinner ermitteln</button>
        </div>
        <p class="small">Ablauf: Start → Schätzwert → Bet1 → Hinweis1/Bet2 → Hinweis2/Bet3 → Lösung → Gewinner.</p>
        <div id="questionBox" class="card" style="margin-top:8px"></div>
      </div>
      <div class="card" style="flex:1">
        <h2 class="h">Sounds</h2>
        <div class="row">
          <button class="btn" data-snd="buzzer">Buzzer</button>
          <button class="btn ok" data-snd="correct">Correct</button>
          <button class="btn bad" data-snd="wrong">Wrong</button>
        </div>
        <h2 class="h" style="margin-top:16px">Status</h2>
        <div id="status"></div>
      </div>
    </div>

    <div class="card">
      <h2 class="h">Virtueller Tisch</h2>
      <div class="table-wrap">
        <div class="table"></div>
        <div id="dealer" class="dealer">D</div>
        <div id="seats"></div>
        <div class="pot">Pot: <span id="pot">0</span></div>
      </div>
    </div>
  </div>

<script>
const adminSock = io('/admin');
const clientSock = io();
let GLOBAL_STATE = null;

function el(id){return document.getElementById(id)}
function h(html){const d=document.createElement('div');d.innerHTML=html;return d.firstElementChild}

function fillQuestions(){
  const sel = el('questionSelect'); sel.innerHTML='';
  for(let i=0;i<50;i++){ 
    const o=document.createElement('option'); 
    o.value=i+1; o.textContent='Frage '+(i+1); 
    sel.appendChild(o); 
  }
}
fillQuestions();

function renderState(st){
  GLOBAL_STATE = st;
  const q = st.round?.question;
  el('questionBox').innerHTML = q ? `
    <div><b>Frage:</b> ${q.frage}</div>
    <div><b>Hinweis 1:</b> ${q.hinweis1 ?? '—'}</div>
    <div><b>Hinweis 2:</b> ${q.hinweis2 ?? '—'}</div>
    <div><b>Lösung:</b> ${q.loesung ?? '—'}</div>
  ` : 'Keine Frage aktiv.';

  el('status').innerHTML = `
    <div>Phase: <b>${st.round.phase}</b></div>
    <div>Pot: <b>${st.round.pot}</b> | Current Bet: <b>${st.round.currentBet}</b></div>
    <div>Hinweise: <b>${st.round.hintsRevealed}</b></div>
    <div>Spieler: ${Object.values(st.players).map(p=>`${p.name}${p.hasGuessed?' ✅':''}`).join(', ')}</div>
  `;

  const seatsWrap = el('seats'); seatsWrap.innerHTML='';
  st.seats.forEach((sid,i)=>{
    const p = sid ? st.players[sid] : null;
    const seat = h(`<div class="seat s${i}"></div>`);
    seat.innerHTML = p ? `
      ${p.avatar?`<img src="${p.avatar}" alt="avatar"/>`:`<img src="https://api.dicebear.com/7.x/thumbs/svg?seed=${encodeURIComponent(p.name)}" alt="avatar"/>`}
      <div class="name">${p.name} <span class="badge">Sitz ${i}</span></div>
      <div class="chips">${p.chips} Chips</div>
    ` : `<div class="name">(frei)</div><div class="chips">—</div>`;
    if(p && st.round.actingSeat===p.seat){ seat.classList.add('turn'); }
    seatsWrap.appendChild(seat);
  });
  el('pot').textContent = st.round.pot;

  const dealer = el('dealer'); dealer.style.display='none';
  const dSeat = st.table.dealerSeat;
  const dEl = seatsWrap.querySelector('.seat.s'+dSeat);
  if(dEl){ dealer.style.display='block'; dealer.style.left=(dEl.offsetLeft + 8)+'px'; dealer.style.top=(dEl.offsetTop - 12)+'px'; }
}

adminSock.on('state', renderState);
clientSock.on('state', renderState);
adminSock.on('winner', ({ winnerSid, solution }) => {
  const p = GLOBAL_STATE?.players?.[winnerSid];
  alert(`Gewinner: ${p?.name || '—'} (Lösung: ${solution})`);
});
adminSock.on('sound', ({key})=> playSound(key));
clientSock.on('sound', ({key})=> playSound(key));

function playSound(key){
  const m = { buzzer:'/sounds/buzzer.mp3', correct:'/sounds/correct.mp3', wrong:'/sounds/wrong.mp3' };
  const src = m[key]; if(src){ const a=new Audio(src); a.play().catch(()=>{}); }
}

document.querySelectorAll('[data-snd]').forEach(b=> b.onclick=()=> adminSock.emit('playSound', { key: b.dataset.snd }));
el('startRound').onclick = ()=> adminSock.emit('startRound', { questionId: el('questionSelect').value });
el('revealHint1').onclick = ()=> adminSock.emit('revealHint', 1);
el('revealHint2').onclick = ()=> adminSock.emit('revealHint', 2);
el('goReveal').onclick   = ()=> adminSock.emit('goReveal');
el('resolveWinner').onclick = ()=> adminSock.emit('resolveWinner');
</script>
</body>
</html>
