<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker – Admin</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    .tbl { width:100%; border-collapse:collapse; font-size:14px }
    .tbl th,.tbl td{ border:1px solid #2a2f3a; padding:6px 8px; text-align:left }
    .badge{ display:inline-block; padding:1px 6px; border-radius:6px; font-size:11px; border:1px solid #2a2f3a; margin-left:6px }
    .badge.sb{ background:#20324b }
    .badge.bb{ background:#4b2020 }
    .tiny{ font-size:12px; opacity:.8 }
    .turn{ outline:2px solid #7aa2ff; border-radius:12px }

    /* --- Tisch & Seats: absolute Layer, keine Flex-Row --- */
    .table-wrap{ position:relative; min-height:520px }
    .table{ position:absolute; inset:0; border-radius:999px;
            background:radial-gradient(circle at 50% 35%, #203142 0, #111826 60%);
            box-shadow:0 0 40px rgba(0,0,0,.5); z-index:1; }
    #seats{ position:absolute; inset:0; z-index:2; }       /* WICHTIG: keine .row/.flex hier */
    .seat{ position:absolute; width:160px; text-align:center;
           padding:8px; border:1px solid #262b36; border-radius:12px; background:#0b0f18 }
    .seat img{ width:44px; height:44px; border-radius:10px; object-fit:cover }
    .seat .name{ margin-top:4px }
    .dealer{ position:absolute; width:20px; height:20px; background:#ffd54a; color:#000;
             border-radius:50%; display:flex; align-items:center; justify-content:center;
             font-weight:700; z-index:3 }
    .pot{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
          padding:6px 12px; border:1px solid #262b36; border-radius:999px;
          background:#0f1118; z-index:4 }

    /* 8 feste Sitz-Positionen am Oval (s0..s7) */
    .s0{left:50%;top:6%; transform:translate(-50%,0)}
    .s1{left:80%;top:18%; transform:translate(-50%,0)}
    .s2{left:92%;top:50%; transform:translate(-50%,-50%)}
    .s3{left:80%;top:82%; transform:translate(-50%,-100%)}
    .s4{left:50%;top:94%; transform:translate(-50%,-100%)}
    .s5{left:20%;top:82%; transform:translate(-50%,-100%)}
    .s6{left:8%; top:50%; transform:translate(-50%,-50%)}
    .s7{left:20%;top:18%; transform:translate(-50%,0)}

    .controls .btn{ margin-right:6px; margin-top:6px }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end }
    .card { background:#0f1118; border:1px solid #262b36; border-radius:12px; padding:12px; margin-bottom:12px }
    .container{ max-width:1200px; margin:0 auto; padding:12px }
    .h{ margin:0 0 8px 0 }
    .btn{ padding:8px 10px; border-radius:10px; border:1px solid #2a2f3a; background:#1a1f2b; cursor:pointer }
    .btn.ok{ background:#1f3a24 }
    .btn.warn{ background:#3a2a1f }
    .btn.bad{ background:#3a1f1f }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    input[type=number]{ width:90px }
    .w120{ width:120px }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="card" style="flex:2">
        <h2 class="h">Runde steuern</h2>
        <div class="row controls">
          <div>
            <div class="tiny">Frage wählen</div>
            <select id="questionSelect" class="w120"></select>
          </div>
          <button class="btn ok" id="startRound">Runde starten</button>
          <button class="btn" id="lockGuesses">Schätzen sperren (weiter zu Bet1)</button>
          <button class="btn" id="revealHint1">Hinweis 1</button>
          <button class="btn" id="revealHint2">Hinweis 2</button>
          <button class="btn warn" id="goReveal">Lösung zeigen</button>
          <button class="btn ok" id="resolveWinner">Gewinner ermitteln</button>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <div class="tiny">Small Blind</div>
            <input id="sbVal" type="number" min="1" value="10" />
          </div>
          <div>
            <div class="tiny">Big Blind</div>
            <input id="bbVal" type="number" min="1" value="20" />
          </div>
          <button class="btn" id="setBlinds">Blinds setzen</button>
          <button class="btn" id="assignBlinds">SB/BB zuweisen (nach Dealer)</button>
          <label class="tiny" style="margin-left:10px"><input type="checkbox" id="revealAll"> Alle Schätzungen sichtbar</label>
        </div>

        <p class="tiny" style="margin-top:6px">
          Ablauf: Start → Schätzwert (sofort & einmalig) → Bet1 → Hinweis1/Bet2 → Hinweis2/Bet3 → Lösung → Gewinner.
          SB/BB dürfen in Bet1 nicht folden. Admin kann Schätzungen für alle sichtbar machen.
        </p>

        <div id="questionBox" class="card" style="margin-top:8px">Keine Frage aktiv.</div>
      </div>

      <div class="card" style="flex:1">
        <h2 class="h">Sounds</h2>
        <div class="row">
          <button class="btn" data-snd="buzzer">Buzzer</button>
          <button class="btn ok" data-snd="correct">Correct</button>
          <button class="btn bad" data-snd="wrong">Wrong</button>
        </div>

        <h2 class="h" style="margin-top:12px">Status</h2>
        <div id="status"></div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:1">
        <h2 class="h">Schätzungen (Admin)</h2>
        <table class="tbl" id="guessTable">
          <thead><tr><th>Spieler</th><th>Schätzung</th><th>Sichtbar</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="flex:1">
        <h2 class="h">Chips & Rebuy (Admin)</h2>
        <table class="tbl" id="chipTable">
          <thead><tr><th>Spieler</th><th>Chips</th><th>Aktionen</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2 class="h">Virtueller Tisch</h2>
      <div class="table-wrap">
        <div class="table"></div>
        <div id="dealer" class="dealer" style="display:none">D</div>
        <!-- Wichtig: #seats ohne class="row" -->
        <div id="seats"></div>
        <div class="pot">Pot: <span id="pot">0</span></div>
      </div>
    </div>
  </div>

<script>
const adminSock = io('/admin');
const clientSock = io();
let GLOBAL_STATE = null;

// Helpers
function el(id){ return document.getElementById(id); }
function h(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstElementChild; }
function fmt(n){ return Number(n||0).toString(); }

// Fragen laden
async function fillQuestions(){
  const sel = el('questionSelect'); sel.innerHTML='';
  try{
    const res = await fetch('/fragen.json');
    const data = await res.json();
    data.forEach(item=>{
      const o = document.createElement('option');
      o.value = item.id;
      o.textContent = `${item.id} – ${item.frage?.slice(0,60) || 'Frage'}`;
      sel.appendChild(o);
    });
    if (!data.length){
      const o = document.createElement('option');
      o.value = 1; o.textContent = '1 – (Backup) Wie viele Minuten hat ein Tag?';
      sel.appendChild(o);
    }
  }catch{
    for(let i=0;i<50;i++){
      const o = document.createElement('option');
      o.value = i+1; o.textContent = 'Frage '+(i+1);
      sel.appendChild(o);
    }
  }
}
fillQuestions();

// Sounds
function playSound(key){
  const m = { buzzer:'/sounds/buzzer.mp3', correct:'/sounds/correct.mp3', wrong:'/sounds/wrong.mp3' };
  const src = m[key]; if(src){ const a=new Audio(src); a.play().catch(()=>{}); }
}

// Rendering
function renderState(st){
  GLOBAL_STATE = st;

  // Frage/Hinweise/Lösung
  const q = st.round?.question;
  el('questionBox').innerHTML = q ? `
    <div><b>Frage:</b> ${q.frage}</div>
    <div><b>Hinweis 1:</b> ${q.hinweis1 ?? '—'}</div>
    <div><b>Hinweis 2:</b> ${q.hinweis2 ?? '—'}</div>
    <div><b>Lösung:</b> ${q.loesung ?? '—'}</div>
  ` : 'Keine Frage aktiv.';

  // Status (Pot/Bet aus table)
  el('status').innerHTML = `
    <div>Phase: <b>${st.round.phase}</b></div>
    <div>Pot: <b>${fmt(st.table.pot)}</b> | Current Bet: <b>${fmt(st.table.currentBet)}</b> | Min Raise: <b>${fmt(st.table.minRaise)}</b></div>
    <div>Hinweise aufgedeckt: <b>${st.round.hintsRevealed || 0}</b></div>
    <div>Spieler: ${Object.values(st.players).map(p=>{
      const role = p.role ? (p.role==='SB' ? 'S' : 'B') : '';
      return `${p.name}${role? ' ['+role+']':''}${p.hasGuessed?' ✅':''}`;
    }).join(', ')}</div>
  `;

  // SB/BB Inputs spiegeln
  el('sbVal').value = st.table.smallBlind ?? el('sbVal').value;
  el('bbVal').value = st.table.bigBlind ?? el('bbVal').value;

  // Seats zeichnen (absolute Positionen s0..s7)
  const seatsWrap = el('seats'); seatsWrap.innerHTML='';
  st.seats.forEach((sid,i)=>{
    const p = sid ? st.players[sid] : null;
    const seat = h(`<div class="seat s${i}"></div>`);
    if (p){
      const roleBadge = p.role ? `<span class="badge ${p.role==='SB'?'sb':'bb'}">${p.role==='SB'?'S':'B'}</span>` : '';
      seat.innerHTML = `
        ${p.avatar?`<img src="${p.avatar}" alt="avatar"/>`:`<img src="https://api.dicebear.com/7.x/thumbs/svg?seed=${encodeURIComponent(p.name)}" alt="avatar"/>`}
        <div class="name">${p.name} <span class="badge">Sitz ${i}</span> ${roleBadge}</div>
        <div class="chips">${fmt(p.chips)} Chips</div>
        <div class="tiny">Committed: ${fmt(p.committed||0)}</div>
      `;
      if(st.table.actingSeat===p.seat){ seat.classList.add('turn'); }
    } else {
      seat.innerHTML = `<div class="name">(frei)</div><div class="chips">—</div>`;
    }
    seatsWrap.appendChild(seat);
  });

  // Dealer-Marker positionieren
  const dealer = el('dealer'); dealer.style.display='none';
  const dSeat = st.table.dealerSeat;
  const dEl = seatsWrap.querySelector('.seat.s'+dSeat);
  if(dEl){
    dealer.style.display='block';
    // mit OffsetLeft/Top relativ zu seatsWrap
    dealer.style.left = (dEl.offsetLeft + 8) + 'px';
    dealer.style.top  = (dEl.offsetTop - 12) + 'px';
  }

  // Pot
  el('pot').textContent = fmt(st.table.pot);
}

function renderAdminGuesses(rows){
  const tb = el('guessTable').querySelector('tbody');
  tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = h(`<tr>
      <td>${r.name}</td>
      <td>${r.value}</td>
      <td><input type="checkbox" ${r.revealed?'checked':''} data-sid="${r.sid}" /></td>
    </tr>`);
    tr.querySelector('input[type=checkbox]').onchange = (e)=>{
      adminSock.emit('admin:revealGuess', { sid: e.target.dataset.sid, reveal: e.target.checked });
    };
    tb.appendChild(tr);
  });
}

// Chips/ Rebuy Tabelle
function renderChipTable(st){
  const tb = el('chipTable').querySelector('tbody');
  tb.innerHTML = '';
  Object.values(st.players).forEach(p=>{
    const tr = h(`<tr>
      <td>${p.name}</td>
      <td>${fmt(p.chips)}</td>
      <td>
        <button class="btn" data-act="add" data-sid="${p.id}" data-d="50">+50</button>
        <button class="btn" data-act="add" data-sid="${p.id}" data-d="100">+100</button>
        <button class="btn" data-act="add" data-sid="${p.id}" data-d="-50">-50</button>
        <button class="btn" data-act="rb"  data-sid="${p.id}">Rebuy</button>
      </td>
    </tr>`);
    tr.querySelectorAll('button').forEach(b=>{
      b.onclick = ()=>{
        const sid = b.dataset.sid;
        if (b.dataset.act === 'add'){
          adminSock.emit('admin:adjustChips', { sid, delta: Number(b.dataset.d) });
        } else if (b.dataset.act === 'rb'){
          const amt = prompt('Rebuy-Betrag eingeben (leer = Standard):','');
          const amount = amt === '' ? undefined : Number(amt);
          adminSock.emit('admin:rebuy', { sid, amount });
        }
      };
    });
    tb.appendChild(tr);
  });
}

// Socket verdrahten
adminSock.on('state', (st)=>{ renderState(st); renderChipTable(st); });
clientSock.on('state', renderState);

adminSock.on('admin:guesses', renderAdminGuesses);
adminSock.on('winner', ({ winnerSid, solution }) => {
  const p = GLOBAL_STATE?.players?.[winnerSid];
  alert(`Gewinner: ${p?.name || '—'} (Lösung: ${solution})`);
});
adminSock.on('sound', ({key})=> playSound(key));
clientSock.on('sound', ({key})=> playSound(key));

// Buttons
document.querySelectorAll('[data-snd]').forEach(b=> b.onclick=()=> adminSock.emit('playSound', { key: b.dataset.snd }));
el('startRound').onclick   = ()=> adminSock.emit('startRound', { questionId: el('questionSelect').value });
el('lockGuesses').onclick  = ()=> adminSock.emit('admin:lockGuesses');
el('revealHint1').onclick  = ()=> adminSock.emit('revealHint', 1);
el('revealHint2').onclick  = ()=> adminSock.emit('revealHint', 2);
el('goReveal').onclick     = ()=> adminSock.emit('goReveal');
el('resolveWinner').onclick= ()=> adminSock.emit('resolveWinner');

el('setBlinds').onclick    = ()=> adminSock.emit('admin:setBlinds', { small:Number(el('sbVal').value), big:Number(el('bbVal').value) });
el('assignBlinds').onclick = ()=> adminSock.emit('admin:assignBlinds');

el('revealAll').onchange   = (e)=> adminSock.emit('admin:revealAllGuesses', { reveal: e.target.checked });
</script>
</body>
</html>
