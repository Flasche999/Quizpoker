<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker – Admin</title>
  <!-- Wichtig: deine globale style.css enthält die runde Tisch-Ansicht -->
  <link rel="stylesheet" href="/style.css?v=5" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    /* ——— Basis-UI (ohne Tisch-Styles, damit style.css greift) ——— */
    :root{--bg:#0e0f12;--card:#151821;--line:#262b36;--ok:#2a5e3b;--err:#5b2730;--pri:#1363ff}
    body{background:var(--bg);color:#e7e9ee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    .layout{display:grid;grid-template-columns:320px 1fr 360px;gap:12px;padding:12px;min-height:100vh}
    .sidebar,.main,.right{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .h{margin:0 0 8px;font-size:16px}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid var(--line);border-radius:10px;padding:8px;background:#0f1118}
    .row{display:flex;gap:8px;align-items:center}
    .row > input, .row > button, .row > select, .row > textarea{border:1px solid var(--line);background:#0f1118;color:#e7e9ee;border-radius:8px;padding:8px}
    .row > button{cursor:pointer}
    .row > button.primary{background:#0f1627;border-color:#1e3a8a}
    .row > button.ok{border-color:var(--ok)}
    .row > button.err{border-color:var(--err)}
    .status{border:1px dashed var(--line);border-radius:10px;padding:8px}
    .small{font-size:12px;opacity:.85}
    .muted{opacity:.7}
    .score .player{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:10px;padding:8px;margin-bottom:8px;background:#0f1118}
    .score .player.turn{border:3px solid gold!important;box-shadow:0 0 10px rgba(255,215,0,.7)}
    .score .player.folded{opacity:.55;filter:saturate(.6)}
    .betline{font-size:12px;opacity:.9}
    .badge{display:inline-block;font-weight:700;color:#000;background:#fff;border-radius:50%;width:20px;height:20px;line-height:20px;text-align:center;margin-left:6px;font-size:12px}
    .badge-s{border:2px solid #1363ff}
    .badge-b{border:2px solid #ff2b2b}

    /* ——— WICHTIG: KEINE lokalen .table-* oder .seat-* Styles mehr hier!
       Wir nutzen die runde Tisch-Ansicht aus /public/style.css (s0..s7, --ring, --seat) ——— */

    /* Platz nach oben rechts schön machen */
    .right { display:flex; flex-direction:column; gap:12px; }
    .table-wrap { display:flex; justify-content:center; } /* nur leichte Hülle */
    #table-center2 .small { display:block; margin-top:4px; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Linke Spalte: Raum/Steuerung -->
    <aside class="sidebar">
      <h3 class="h">Raum</h3>
      <div class="list">
        <div class="item">
          <div>Code: <strong id="roomCode">—</strong></div>
          <div class="small">Frage: <span id="qIndex">–</span></div>
          <div class="small">Runde: <strong id="roundIdx">0</strong> · Aktionen: <strong id="acted">0</strong>/<strong id="need">0</strong></div>
          <div class="small">Aktuelle Bet (Runde): <strong id="currentBet">0</strong></div>
          <div class="small">Pot: <strong id="pot">0</strong></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button id="btnCreate" class="primary">Raum erstellen</button>
        <button id="btnNextQ">🆕 Frage starten</button>
      </div>

      <!-- Blinds (Sitze + Werte + Rotation) -->
      <div class="status" style="margin-top:12px;">
        <div>Small Blind (Seat #): <input id="inpSB" placeholder="0–7" style="width:100%;margin-top:6px;"></div>
        <div>Big Blind (Seat #): <input id="inpBB" placeholder="0–7" style="width:100%;margin-top:6px;"></div>
        <div>Small Blind Betrag: <input id="inpSBVal" type="number" min="0" placeholder="z. B. 10" style="width:100%;margin-top:6px;"></div>
        <div>Big Blind Betrag: <input id="inpBBVal" type="number" min="0" placeholder="z. B. 20" style="width:100%;margin-top:6px;"></div>
        <label class="small" style="display:flex;align-items:center;gap:8px;margin-top:6px;">
          <input id="chkAutoRotate" type="checkbox" checked>
          Blinds pro Frage im Uhrzeigersinn rotieren
        </label>
        <button id="btnSetBlinds" style="margin-top:6px;">Blinds speichern</button>
        <div class="small muted" id="blindInfo" style="margin-top:6px;">Aktuell: SB Seat – / BB Seat – · SB 0 / BB 0 · Rotation AN</div>
      </div>

      <div class="status" style="margin-top:12px;">
        <div class="row">
          <button id="btnRevealH1">🔓 Hinweis 1</button>
          <button id="btnRevealH2">🔓 Hinweis 2</button>
          <button id="btnRevealSol">🔓 Lösung</button>
        </div>
        <div class="small muted">Nur möglich, wenn die jeweilige Aktionsrunde vollständig ist.</div>
      </div>

      <div class="status" style="margin-top:12px;">
        <div class="row">
          <input id="inpTurnUid" placeholder="Turn: UID" style="flex:1;">
          <input id="inpTurnSeat" placeholder="Seat 0–7" style="width:120px;">
        </div>
        <div class="row" style="margin-top:6px;">
          <button id="btnSetTurn">Turn setzen</button>
          <button id="btnNextTurn">⏭️ Nächster Spieler</button>
          <button id="btnSkipFold" class="err">⏳ Spieler überspringen (Fold)</button>
        </div>
      </div>

      <!-- Chips Mgmt (belässt du, wenn du es nutzt) -->
      <div class="status" style="margin-top:12px;">
        <div class="row">
          <input id="chipsSetAll" type="number" placeholder="Startchips (z. B. 1000)" style="flex:1;">
          <button id="btnChipsSetAll" class="ok">Allen setzen</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <input id="chipsDeltaAll" type="number" placeholder="+/− für alle (z. B. 100)" style="flex:1;">
          <button id="btnChipsAddAll">Allen +/−</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <select id="chipsOneUid" style="flex:1;"><option value="">Spieler wählen…</option></select>
          <input id="chipsDeltaOne" type="number" placeholder="+/− für einen" style="width:150px;">
          <button id="btnChipsAddOne">Einzeln +/−</button>
        </div>
      </div>

      <div class="status" style="margin-top:12px;">
        <div class="row">
          <input id="inpWinnerUid" placeholder="Gewinner-UID (manuell)" style="flex:1;">
          <button id="btnAwardPot" class="ok">🏆 Pot auszahlen</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <button id="btnAwardNearest">🏆 Nächstliegenden automatisch</button>
        </div>
      </div>

      <div class="status" id="adminStatus" style="margin-top:12px;"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSyncAll">🔄 Alle synchronisieren</button>
      </div>
    </aside>

    <!-- Mitte: Frage/DMs -->
    <main class="main">
      <h3 class="h">Frage & Hinweise</h3>
      <div class="list">
        <div class="item"><strong>Frage:</strong> <span id="qText">–</span></div>
        <div class="item"><strong>Hinweis 1:</strong> <span id="qH1" class="muted">verdeckt</span></div>
        <div class="item"><strong>Hinweis 2:</strong> <span id="qH2" class="muted">verdeckt</span></div>
        <div class="item"><strong>Lösung:</strong> <span id="qSol" class="muted">verdeckt</span></div>
      </div>

      <h3 class="h" style="margin-top:16px;">Private DMs</h3>
      <div class="item">
        <div class="row">
          <select id="dmSelect" style="flex:1;"><option value="">Spieler wählen…</option></select>
          <button id="btnDmClearOne" class="err">Diesen Chat löschen</button>
          <button id="btnDmClearAll" class="err">Alle Chats löschen</button>
        </div>
        <div class="chatlog" id="dmLog" style="margin-top:8px;"></div>
        <div class="row" style="margin-top:8px;">
          <input id="dmMessage" placeholder="Nachricht an Spieler… (Enter sendet)" style="flex:1;">
          <button id="btnDmSend" class="primary">Senden</button>
        </div>
        <div class="small muted" style="margin-top:4px;">Hinweis: Der Verlauf ist pro Spieler. Auswahl oben ändert den sichtbaren Thread.</div>
      </div>

      <h3 class="h" style="margin-top:16px;">Antworten (live)</h3>
      <div id="answers" class="list" style="max-height:160px;overflow:auto;"></div>
    </main>

    <!-- RECHTS: Oben Virtueller Tisch, darunter Lobby -->
    <aside class="right">
      <div>
        <h3 class="h">Virtueller Tisch</h3>
        <!-- runde Tisch-Ansicht: nutzt Klassen/Variablen aus style.css -->
        <div class="table-wrap">
          <div class="table-circle">
            <div class="seat s0" data-seat="0"></div>
            <div class="seat s1" data-seat="1"></div>
            <div class="seat s2" data-seat="2"></div>
            <div class="seat s3" data-seat="3"></div>
            <div class="seat s4" data-seat="4"></div>
            <div class="seat s5" data-seat="5"></div>
            <div class="seat s6" data-seat="6"></div>
            <div class="seat s7" data-seat="7"></div>
            <div id="table-center2">
              💰 Pot: <strong id="pot2">0</strong>
              <span class="small muted" id="blindVals">SB — / BB —</span>
            </div>
          </div>
        </div>
      </div>

      <div>
        <h3 class="h" style="margin-top:8px;">Lobby – Spieler</h3>
        <div id="players" class="score"></div>
      </div>
    </aside>
  </div>

  <script>
    const socket = io({ path:'/socket.io', transports:['websocket','polling'] });
    const el = (s)=>document.querySelector(s);
    const state = { blinds:{small:null,big:null,sbValue:0,bbValue:0,autoRotate:true}, turnUid:null, roundIndex:0, chats:new Map(), players:[] };

    const emitOk = (evt, payload)=>{ if(!socket.connected){ el('#adminStatus').textContent='Nicht verbunden.'; return false; } socket.emit(evt,payload); return true; };

    // Connect / Restore
    socket.on('connect', ()=>{
      el('#adminStatus').textContent = 'Verbunden: '+socket.id;
      const last = localStorage.getItem('qp_admin_room'); if (last) socket.emit('mod:claim-room', { code:last });
    });
    socket.on('disconnect', ()=>{ el('#adminStatus').textContent='Getrennt.'; });

    // Buttons
    el('#btnCreate').onclick=()=>emitOk('mod:create-room');
    el('#btnNextQ').onclick =()=>emitOk('mod:next-question');

    // Blinds speichern (Seats + Werte + Rotation)
    el('#btnSetBlinds').onclick = ()=>{
      const sbSeatStr=el('#inpSB').value.trim();
      const bbSeatStr=el('#inpBB').value.trim();
      const sbVal=Number(el('#inpSBVal').value.trim()||0);
      const bbVal=Number(el('#inpBBVal').value.trim()||0);
      const autoRotate = !!el('#chkAutoRotate').checked;

      const small = sbSeatStr===''?null:Number(sbSeatStr);
      const big   = bbSeatStr===''?null:Number(bbSeatStr);

      emitOk('mod:set-blinds',{ small, big, sbValue:sbVal, bbValue:bbVal, autoRotate });
    };

    el('#btnRevealH1').onclick=()=>emitOk('mod:reveal-hint1');
    el('#btnRevealH2').onclick=()=>emitOk('mod:reveal-hint2');
    el('#btnRevealSol').onclick=()=>emitOk('mod:reveal-solution');

    el('#btnSetTurn').onclick = ()=>{
      const uid=el('#inpTurnUid').value.trim(); const seatStr=el('#inpTurnSeat').value.trim();
      const seat = seatStr==='' ? undefined : Number(seatStr);
      emitOk('mod:set-turn',{ uid: uid || undefined, seat: Number.isInteger(seat)?seat:undefined });
    };
    el('#btnNextTurn').onclick = ()=>emitOk('mod:next-turn');
    el('#btnSkipFold').onclick = ()=>emitOk('mod:skip-fold');

    el('#btnAwardPot').onclick=()=>{
      const uid=el('#inpWinnerUid').value.trim(); if(!uid) return; emitOk('mod:award-pot',{ uid });
    };
    el('#btnAwardNearest').onclick=()=>emitOk('mod:award-nearest');
    el('#btnSyncAll').onclick=()=>emitOk('mod:sync-all');

    // Chips Mgmt
    el('#btnChipsSetAll').onclick=()=>emitOk('mod:chips-set-all', { amount: Number(el('#chipsSetAll').value || 0) });
    el('#btnChipsAddAll').onclick=()=>emitOk('mod:chips-add-all', { delta: Number(el('#chipsDeltaAll').value || 0) });
    el('#btnChipsAddOne').onclick=()=>{
      const uid = el('#chipsOneUid').value;
      const delta = Number(el('#chipsDeltaOne').value || 0);
      if (!uid) { el('#adminStatus').textContent='Bitte Spieler wählen.'; return; }
      emitOk('mod:chips-add-one', { uid, delta });
    };

    // DMs (Admin-Seite)
    const dmSelect = el('#dmSelect');
    const dmLog = el('#dmLog');
    function dmAppend(html){
      const d=document.createElement('div'); d.className='chatrow'; d.innerHTML=html;
      dmLog.appendChild(d); dmLog.scrollTop = dmLog.scrollHeight;
    }
    function escapeHtml(s){return String(s||'').replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));}
    function renderDmFor(uid){
      dmLog.innerHTML='';
      const thread = state.chats.get(uid) || [];
      thread.forEach(t=>{
        const who = t.from==='admin' ? '<span class="pill admin">Admin</span>' : '<span class="pill player">Spieler</span>';
        dmAppend(`${who} ${new Date(t.ts).toLocaleTimeString()} — ${escapeHtml(t.message)}`);
      });
    }
    dmSelect.onchange = ()=>{ if(dmSelect.value) renderDmFor(dmSelect.value); };
    function ensureChat(uid){ if(!state.chats.has(uid)) state.chats.set(uid,[]); return state.chats.get(uid); }
    el('#btnDmSend').onclick = ()=>{
      const uid = dmSelect.value; const msg = el('#dmMessage').value.trim();
      if(!uid || !msg) return;
      emitOk('mod:dm', { uid, message: msg });
      const thr = ensureChat(uid);
      thr.push({ from:'admin', message:msg, ts:Date.now() });
      renderDmFor(uid);
      el('#dmMessage').value = '';
    };
    el('#btnDmClearOne').onclick = ()=>{ const uid = dmSelect.value; if(!uid) return; emitOk('mod:chat-clear-one', { uid }); };
    el('#btnDmClearAll').onclick = ()=>emitOk('mod:chat-clear-all');
    el('#dmMessage').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); el('#btnDmSend').click(); }});

    // Render-Helfer
    function badge(p){
      const isSB = (p.seat === (state.blinds?.small ?? null));
      const isBB = (p.seat === (state.blinds?.big ?? null));
      return (isSB?'<span class="badge badge-s">S</span>':'') + (isBB?'<span class="badge badge-b">B</span>':'');
    }
    function refreshSelects(players){
      const keeps = new Set();
      const curDm = dmSelect.value;
      const curChip = el('#chipsOneUid').value;
      dmSelect.innerHTML = '<option value="">Spieler wählen…</option>';
      el('#chipsOneUid').innerHTML = '<option value="">Spieler wählen…</option>';
      players.forEach(p=>{
        const opt1=document.createElement('option'); opt1.value=p.uid; opt1.textContent=`${p.name} (${p.uid.slice(0,6)}…)`;
        const opt2=opt1.cloneNode(true);
        dmSelect.appendChild(opt1);
        el('#chipsOneUid').appendChild(opt2);
        keeps.add(p.uid);
      });
      if (keeps.has(curDm)) dmSelect.value = curDm;
      if (keeps.has(curChip)) el('#chipsOneUid').value = curChip;
    }
    function renderTop(st){
      el('#roomCode').textContent = st.code || '—';
      el('#qIndex').textContent = st.qIndex>=0 ? (st.qIndex+1) : '–';
      el('#roundIdx').textContent = st.roundIndex||0;
      el('#acted').textContent = st.actedCount||0;
      el('#need').textContent = st.needCount||0;
      el('#currentBet').textContent = st.currentBetRound||0;
      el('#pot').textContent = st.pot||0;
      el('#pot2').textContent = st.pot||0;

      el('#qText').textContent = st.question?.text || '–';
      el('#qH1').textContent   = st.question?.hint1 ?? 'verdeckt';
      el('#qH2').textContent   = st.question?.hint2 ?? 'verdeckt';
      el('#qSol').textContent  = st.question?.solution ?? 'verdeckt';

      state.blinds = st.blinds||{small:null,big:null,sbValue:0,bbValue:0,autoRotate:true};
      state.turnUid = st.turnUid || null;
      state.roundIndex = st.roundIndex||0;

      // Blind-Werte im Tischzentrum
      el('#blindVals').textContent = `SB ${state.blinds.sbValue ?? 0} / BB ${state.blinds.bbValue ?? 0}`;

      // Panel-Felder
      if (st.blinds){
        el('#inpSB').value = Number.isInteger(st.blinds.small) ? st.blinds.small : '';
        el('#inpBB').value = Number.isInteger(st.blinds.big) ? st.blinds.big : '';
        el('#inpSBVal').value = st.blinds.sbValue ?? 0;
        el('#inpBBVal').value = st.blinds.bbValue ?? 0;
        el('#chkAutoRotate').checked = !!st.blinds.autoRotate;
        el('#blindInfo').textContent = `Aktuell: SB Seat ${st.blinds.small ?? '–'} / BB Seat ${st.blinds.big ?? '–'} · SB ${st.blinds.sbValue ?? 0} / BB ${st.blinds.bbValue ?? 0} · Rotation ${st.blinds.autoRotate?'AN':'AUS'}`;
      }
    }
    function renderPlayers(st){
      state.players = (st.players||[]).slice();
      const wrap = el('#players'); wrap.innerHTML='';
      const arr = state.players.slice().sort((a,b)=>(a.seat??99)-(b.seat??99));
      arr.forEach(p=>{
        const div=document.createElement('div');
        div.className='player'+(p.uid===state.turnUid?' turn':'')+(p.status==='folded'?' folded':'');
        const est = (p.estimate===null || typeof p.estimate==='number') ? (p.estimate===null?'—':p.estimate) : '—';
        div.innerHTML=`
          <div class="row" style="justify-content:space-between;">
            <span title="UID: ${p.uid}">${p.name} ${p.connected?'🟢':'🔴'} ${badge(p)}</span>
            <strong>🪙 ${p.chips||0}</strong>
          </div>
          <div class="small betline">Runde: 🪙 ${p.betRound||0} · Gesamt: 🪙 ${p.betTotal||0} ${p.status==='allin'?' · (All-in)':''}${p.status==='folded'?' · (Fold)':''}</div>
          <div class="small">Schätzwert: <strong>${est}</strong></div>
        `;
        wrap.appendChild(div);
      });
      refreshSelects(arr);
    }
    function renderSeats(st){
      // setzt die Sitzkarten in die runde Tisch-UI (nutzt CSS aus style.css)
      for(let i=0;i<8;i++){
        const slot = document.querySelector(`.seat[data-seat="${i}"]`);
        if(!slot) continue;
        slot.className = `seat s${i}`;
        slot.innerHTML = '<div class="avatar">🙂</div><div class="name">Frei</div><div class="chips">🪙 0</div><div class="betline">Runde: 🪙 0 · Gesamt: 🪙 0</div>';
      }
      (st.players||[]).forEach(p=>{
        if(typeof p.seat!=='number') return;
        const slot=document.querySelector(`.seat[data-seat="${p.seat}"]`); if(!slot) return;
        const est = (p.estimate===null || typeof p.estimate==='number') ? (p.estimate===null?'—':p.estimate) : '—';
        slot.innerHTML = `<div class="avatar">🙂</div>
          <div class="name">${p.name} ${badge(p)}</div>
          <div class="chips">🪙 ${p.chips??0}</div>
          <div class="betline">Runde: 🪙 ${p.betRound||0} · Gesamt: 🪙 ${p.betTotal||0}</div>
          <div class="small">Schätzwert: <strong>${est}</strong></div>`;
        if(!p.connected) slot.classList.add('disconnected');
        if(p.status==='folded') slot.classList.add('folded');
        if(p.uid===state.turnUid) slot.classList.add('turn');
      });
    }

    // Socket-Events
    socket.on('mod:room-created', ({ code, state:st })=>{
      localStorage.setItem('qp_admin_room', code);
      renderTop(st); renderPlayers(st); renderSeats(st);
      el('#adminStatus').textContent = 'Raum erstellt: '+code;
    });
    socket.on('state:full', (st)=>{ renderTop(st); renderPlayers(st); renderSeats(st); });
    socket.on('players:update', (msg)=>{ if(!msg?.players) return; renderPlayers({players:msg.players, blinds:state.blinds, turnUid:state.turnUid}); renderSeats({players:msg.players, blinds:state.blinds, turnUid:state.turnUid}); });
    socket.on('state:partial', (patch)=>{
      if (patch.blinds) {
        state.blinds = patch.blinds;
        el('#inpSB').value = Number.isInteger(patch.blinds.small) ? patch.blinds.small : '';
        el('#inpBB').value = Number.isInteger(patch.blinds.big) ? patch.blinds.big : '';
        el('#inpSBVal').value = patch.blinds.sbValue ?? 0;
        el('#inpBBVal').value = patch.blinds.bbValue ?? 0;
        el('#chkAutoRotate').checked = !!patch.blinds.autoRotate;
        el('#blindVals').textContent = `SB ${patch.blinds.sbValue ?? 0} / BB ${patch.blinds.bbValue ?? 0}`;
        el('#blindInfo').textContent = `Aktuell: SB Seat ${patch.blinds.small ?? '–'} / BB Seat ${patch.blinds.big ?? '–'} · SB ${patch.blinds.sbValue ?? 0} / BB ${patch.blinds.bbValue ?? 0} · Rotation ${patch.blinds.autoRotate?'AN':'AUS'}`;
      }
      if ('turnUid' in patch) state.turnUid = patch.turnUid;
      if ('roundIndex' in patch) state.roundIndex = patch.roundIndex;
      if ('actedCount' in patch) el('#acted').textContent = patch.actedCount;
      if ('needCount' in patch) el('#need').textContent = patch.needCount;
      if ('currentBetRound' in patch) el('#currentBet').textContent = patch.currentBetRound;
      if ('pot' in patch) { el('#pot').textContent = patch.pot; el('#pot2').textContent = patch.pot; }
      if (patch.question) {
        el('#qText').textContent = patch.question?.text || '–';
        el('#qH1').textContent   = patch.question?.hint1 ?? 'verdeckt';
        el('#qH2').textContent   = patch.question?.hint2 ?? 'verdeckt';
        el('#qSol').textContent  = patch.question?.solution ?? 'verdeckt';
      }
      socket.emit('mod:sync-all');
    });
    socket.on('question:show', (q)=>{
      el('#qIndex').textContent = (q.index+1);
      el('#qText').textContent = q.text || '–';
      el('#qH1').textContent='verdeckt'; el('#qH2').textContent='verdeckt'; el('#qSol').textContent='verdeckt';
    });
    socket.on('answer:received', ({ uid, name, answer })=>{
      const div=document.createElement('div'); div.className='item'; div.textContent = `${name}: ${answer}`;
      el('#answers').prepend(div);
    });

    // DMs von Spielern
    socket.on('dm:from-player', ({ uid, name, message, ts })=>{
      const thr = ensureChat(uid); thr.push({ from:'player', message, ts });
      if (dmSelect.value === uid) renderDmFor(uid);
    });
    socket.on('dm:sent', ({ uid, name, message, ts })=>{
      const thr = ensureChat(uid); thr.push({ from:'admin', message, ts });
      if (dmSelect.value === uid) renderDmFor(uid);
    });
    socket.on('dm:cleared-one', ({ uid })=>{
      state.chats.set(uid, []);
      if (dmSelect.value === uid) renderDmFor(uid);
    });
    socket.on('dm:cleared-all', ()=>{
      state.chats.clear(); dmLog.innerHTML='';
    });

    socket.on('status', (t)=>{ el('#adminStatus').textContent = t; });
  </script>
</body>
</html>
