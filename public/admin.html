<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker – Admin</title>
  <link rel="stylesheet" href="/style.css?v=4" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    .badge{display:inline-block;font-weight:700;color:#000;background:#fff;border-radius:50%;width:20px;height:20px;line-height:20px;text-align:center;margin-left:6px;font-size:12px}
    .badge-s{border:2px solid #1363ff}.badge-b{border:2px solid #ff2b2b}
    .seat.turn,.player.turn{border:3px solid gold!important;box-shadow:0 0 10px rgba(255,215,0,.7);border-radius:10px}
    .seat.folded,.player.folded{opacity:.5;filter:saturate(.5)}
    .betline{font-size:12px;opacity:.9}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h3 class="h">Raum</h3>
      <div class="list">
        <div class="item">
          <div>Code: <strong id="roomCode">—</strong></div>
          <div class="small">Frage: <span id="qIndex">–</span></div>
          <div class="small">Runde: <strong id="roundIdx">0</strong> · Aktionen: <strong id="acted">0</strong>/<strong id="need">0</strong></div>
          <div class="small">Aktuelle Bet (Runde): <strong id="currentBet">0</strong></div>
          <div class="small">Pot: <strong id="pot">0</strong></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button id="btnCreate" class="primary">Raum erstellen</button>
        <button id="btnNextQ">🆕 Frage starten</button>
      </div>

      <div class="status" style="margin-top:12px;">
        <div>Small Blind (Seat #): <input id="inpSB" placeholder="0–7" style="width:100%;margin-top:6px;"></div>
        <div>Big Blind (Seat #): <input id="inpBB" placeholder="0–7" style="width:100%;margin-top:6px;"></div>
        <button id="btnSetBlinds" style="margin-top:6px;">Blinds setzen</button>
      </div>

      <div class="status" style="margin-top:12px;">
        <div class="row">
          <button id="btnRevealH1">🔓 Hinweis 1 aufdecken</button>
          <button id="btnRevealH2">🔓 Hinweis 2 aufdecken</button>
          <button id="btnRevealSol">🔓 Lösung aufdecken</button>
        </div>
        <div class="small muted">Nur möglich, wenn die vorherige Aktionsrunde komplett ist.</div>
      </div>

      <div class="status" style="margin-top:12px;">
        <div>Turn an (UID oder Seat#):</div>
        <div class="row">
          <input id="inpTurnUid" placeholder="UID" style="flex:1;">
          <input id="inpTurnSeat" placeholder="Seat 0–7" style="width:120px;">
        </div>
        <button id="btnSetTurn" style="margin-top:6px;">Zug setzen</button>
      </div>

      <div class="status" style="margin-top:12px;">
        <div class="row">
          <input id="inpWinnerUid" placeholder="Gewinner-UID (manuell)" style="flex:1;">
          <button id="btnAwardPot" class="ok">🏆 Pot auszahlen</button>
        </div>
        <div class="row" style="margin-top:6px;">
          <button id="btnAwardNearest">🏆 Nächstliegenden automatisch</button>
        </div>
      </div>

      <div class="status" id="adminStatus"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSyncAll">🔄 Alle synchronisieren</button>
      </div>
    </aside>

    <main class="main">
      <h3 class="h">Frage & Hinweise</h3>
      <div class="list">
        <div class="item"><strong>Frage:</strong> <span id="qText">–</span></div>
        <div class="item"><strong>Hinweis 1:</strong> <span id="qH1" class="muted">verdeckt</span></div>
        <div class="item"><strong>Hinweis 2:</strong> <span id="qH2" class="muted">verdeckt</span></div>
        <div class="item"><strong>Lösung:</strong> <span id="qSol" class="muted">verdeckt</span></div>
      </div>

      <h3 class="h" style="margin-top:16px;">Antworten (live)</h3>
      <div id="answers" class="list" style="max-height:240px;overflow:auto;"></div>
    </main>

    <aside class="right">
      <h3 class="h">Lobby – Spieler</h3>
      <div id="players" class="score"></div>

      <h3 class="h" style="margin-top:12px;">Virtueller Tisch</h3>
      <div class="table-wrap">
        <div class="table-circle">
          <div class="seat s0" data-seat="0"></div>
          <div class="seat s1" data-seat="1"></div>
          <div class="seat s2" data-seat="2"></div>
          <div class="seat s3" data-seat="3"></div>
          <div class="seat s4" data-seat="4"></div>
          <div class="seat s5" data-seat="5"></div>
          <div class="seat s6" data-seat="6"></div>
          <div class="seat s7" data-seat="7"></div>
          <div id="table-center2">💰 Pot: <strong id="pot2">0</strong></div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    const socket = io({ path:'/socket.io', transports:['websocket','polling'] });
    const el = (s)=>document.querySelector(s);
    const state = { blinds:{small:null,big:null}, turnUid:null, roundIndex:0, acted:0, need:0, currentBetRound:0 };

    socket.on('connect', ()=>{
      el('#adminStatus').textContent = 'Verbunden: '+socket.id;
      const last = localStorage.getItem('qp_admin_room'); if (last) socket.emit('mod:claim-room', { code:last });
    });
    socket.on('disconnect', ()=>{ el('#adminStatus').textContent='Getrennt.'; });

    function emitOk(evt, payload){ if(!socket.connected){ el('#adminStatus').textContent='Nicht verbunden.'; return false; } socket.emit(evt,payload); return true; }

    // Buttons
    el('#btnCreate').onclick=()=>emitOk('mod:create-room');
    el('#btnNextQ').onclick =()=>emitOk('mod:next-question');
    el('#btnSetBlinds').onclick = ()=>{
      const sb=el('#inpSB').value.trim(), bb=el('#inpBB').value.trim();
      emitOk('mod:set-blinds',{ small: sb===''?null:Number(sb), big: bb===''?null:Number(bb) });
    };
    el('#btnRevealH1').onclick=()=>emitOk('mod:reveal-hint1');
    el('#btnRevealH2').onclick=()=>emitOk('mod:reveal-hint2');
    el('#btnRevealSol').onclick=()=>emitOk('mod:reveal-solution');
    el('#btnSetTurn').onclick = ()=>{
      const uid=el('#inpTurnUid').value.trim(); const seatStr=el('#inpTurnSeat').value.trim(); const seat=seatStr===''?null:Number(seatStr);
      emitOk('mod:set-turn',{ uid: uid||undefined, seat: Number.isInteger(seat)?seat:undefined });
    };
    el('#btnAwardPot').onclick=()=>{
      const uid=el('#inpWinnerUid').value.trim(); if(!uid) return; emitOk('mod:award-pot',{ uid });
    };
    el('#btnAwardNearest').onclick=()=>emitOk('mod:award-nearest');
    el('#btnSyncAll').onclick=()=>emitOk('mod:sync-all');

    // Rendering helpers
    function badge(p){
      const isSB = (p.seat === (state.blinds?.small ?? null));
      const isBB = (p.seat === (state.blinds?.big ?? null));
      return (isSB?'<span class="badge badge-s">S</span>':'') + (isBB?'<span class="badge badge-b">B</span>':'');
    }
    function renderTop(st){
      el('#roomCode').textContent = st.code || '—';
      el('#qIndex').textContent = st.qIndex>=0 ? (st.qIndex+1) : '–';
      el('#roundIdx').textContent = st.roundIndex||0;
      el('#acted').textContent = st.actedCount||0;
      el('#need').textContent = st.needCount||0;
      el('#currentBet').textContent = st.currentBetRound||0;
      el('#pot').textContent = st.pot||0;
      el('#pot2').textContent = st.pot||0;

      // Frage/Hints
      el('#qText').textContent = st.question?.text || '–';
      el('#qH1').textContent   = st.question?.hint1 ?? 'verdeckt';
      el('#qH2').textContent   = st.question?.hint2 ?? 'verdeckt';
      el('#qSol').textContent  = st.question?.solution ?? 'verdeckt';
      state.blinds = st.blinds||{small:null,big:null};
      state.turnUid = st.turnUid || null;
      state.roundIndex = st.roundIndex||0;
    }
    function renderPlayers(st){
      const wrap = el('#players'); wrap.innerHTML='';
      const arr = (st.players||[]).slice().sort((a,b)=>(a.seat??99)-(b.seat??99));
      arr.forEach(p=>{
        const div=document.createElement('div');
        div.className='player'+(p.uid===state.turnUid?' turn':'')+(p.status==='folded'?' folded':'');
        div.innerHTML=`
          <span title="UID: ${p.uid}">${p.name} ${p.connected?'🟢':'🔴'} ${badge(p)}</span>
          <strong>🪙 ${p.chips||0}</strong>
          <div class="small betline">Gesamt: 🪙 ${p.betTotal||0} · Runde: 🪙 ${p.betRound||0} ${p.status==='allin'?' · (All-in)':''}${p.status==='folded'?' · (Fold)':''}</div>
        `;
        wrap.appendChild(div);
      });
    }
    function renderSeats(st){
      for(let i=0;i<8;i++){
        const slot = document.querySelector(`.seat[data-seat="${i}"]`);
        if(!slot) continue;
        slot.className = `seat s${i}`;
        slot.innerHTML = '<div class="avatar">—</div><div class="name">Frei</div><div class="chips">🪙 0</div><div class="betline">Runde: 🪙 0 · Gesamt: 🪙 0</div>';
      }
      (st.players||[]).forEach(p=>{
        if(typeof p.seat!=='number') return;
        const slot=document.querySelector(`.seat[data-seat="${p.seat}"]`); if(!slot) return;
        slot.innerHTML = `<div class="avatar">🙂</div><div class="name">${p.name} ${badge(p)}</div><div class="chips">🪙 ${p.chips??0}</div><div class="betline">Runde: 🪙 ${p.betRound||0} · Gesamt: 🪙 ${p.betTotal||0} ${p.status==='allin'?' · (All-in)':''}${p.status==='folded'?' · (Fold)':''}</div>`;
        if(!p.connected) slot.classList.add('disconnected');
        if(p.status==='folded') slot.classList.add('folded');
        if(p.uid===state.turnUid) slot.classList.add('turn');
      });
    }

    // Socket events
    socket.on('mod:room-created', ({ code, state:st })=>{
      localStorage.setItem('qp_admin_room', code);
      renderTop(st); renderPlayers(st); renderSeats(st);
      el('#adminStatus').textContent = 'Raum erstellt: '+code;
    });

    socket.on('state:full', (st)=>{ renderTop(st); renderPlayers(st); renderSeats(st); });
    socket.on('players:update', (msg)=>{ if(!msg?.players) return; const st={...state, players:msg.players, pot:Number(el('#pot').textContent)||0, qIndex:Number(el('#qIndex').textContent)||-1, roundIndex: state.roundIndex}; renderPlayers({players:msg.players}); renderSeats({players:msg.players}); });
    socket.on('state:partial', (patch)=>{
      if (patch.blinds) state.blinds = patch.blinds;
      if ('turnUid' in patch) state.turnUid = patch.turnUid;
      if ('roundIndex' in patch) state.roundIndex = patch.roundIndex;
      if ('actedCount' in patch) el('#acted').textContent = patch.actedCount;
      if ('needCount' in patch) el('#need').textContent = patch.needCount;
      if ('currentBetRound' in patch) { el('#currentBet').textContent = patch.currentBetRound; }
      if ('pot' in patch) { el('#pot').textContent = patch.pot; el('#pot2').textContent = patch.pot; }
      if (patch.question || patch.reveals) {
        // Ziehen uns frischen full-question aus question
        const q = patch.question;
        if (q) {
          el('#qText').textContent = q.text || '–';
          el('#qH1').textContent   = q.hint1 ?? 'verdeckt';
          el('#qH2').textContent   = q.hint2 ?? 'verdeckt';
          el('#qSol').textContent  = q.solution ?? 'verdeckt';
        }
      }
      // Turn Markierung neu setzen
      const stDummy = { players: Array.from(document.querySelectorAll('#players .player')).map(()=>({})) }; // kein repaint hier
      // besser: triggere komplettes Repaint über sync-all kleiner Hack:
      socket.emit('mod:sync-all');
    });
    socket.on('question:show', (q)=>{ el('#qIndex').textContent = (q.index+1); el('#qText').textContent = q.text || '–'; el('#qH1').textContent='verdeckt'; el('#qH2').textContent='verdeckt'; el('#qSol').textContent='verdeckt'; });

    socket.on('answer:received', ({ uid, name, answer })=>{
      const div=document.createElement('div'); div.className='item'; div.textContent = `${name}: ${answer}`;
      el('#answers').prepend(div);
    });

    socket.on('status', (t)=>{ el('#adminStatus').textContent = t; });
  </script>
</body>
</html>
