<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuizPoker – Admin</title>
  <link rel="stylesheet" href="/style.css?v=4" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h3 class="h">Raum</h3>
      <div class="list">
        <div class="item">
          <div>Code: <strong id="roomCode">—</strong></div>
          <div class="small">Frage: <span id="qIndex">–</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnCreate" class="primary">Raum erstellen</button>
        <button id="btnNextQ">➡️ Nächste Frage</button>
      </div>

      <div class="status" style="margin-top:12px;">
        <div>Small Blind: <input id="inpSB" placeholder="Name" style="width:100%;margin-top:6px;"></div>
        <div>Big Blind: <input id="inpBB" placeholder="Name" style="width:100%;margin-top:6px;"></div>
        <button id="btnSetBlinds" style="margin-top:6px;">Blinds setzen</button>
      </div>

      <div class="status" id="adminStatus"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSyncAll">🔄 Alle synchronisieren</button>
      </div>
    </aside>

    <main class="main">
      <h3 class="h">Frage</h3>
      <div id="questionBox" class="status" style="font-size:16px;">–</div>

      <div class="row" style="margin-top:10px;">
        <label style="display:flex; gap:6px; align-items:center;">
          UID: <input id="uidTarget" placeholder="Spieler-UID" style="width:240px;">
        </label>
        <label style="display:flex; gap:6px; align-items:center;">
          Δ Chips: <input id="deltaChips" type="number" value="10" style="width:120px;">
        </label>
        <button id="btnMarkCorrect" class="ok">✅ Korrekt</button>
        <button id="btnMarkWrong"  class="err">❌ Falsch</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnMinus" class="err">− Manuell</button>
        <button id="btnPlus"  class="ok">+ Manuell</button>
      </div>

      <div class="status" id="status"></div>

      <h3 class="h" style="margin-top:16px;">Antworten (live)</h3>
      <div id="answers" class="list" style="max-height:240px;overflow:auto;"></div>
    </main>

    <aside class="right">
      <h3 class="h">Lobby – Spieler</h3>
      <div id="players" class="score"></div>

      <h3 class="h" style="margin-top:12px;">Virtueller Tisch</h3>
      <div class="table-wrap">
        <div class="table-circle">
          <div class="seat s0" data-seat="0"></div>
          <div class="seat s1" data-seat="1"></div>
          <div class="seat s2" data-seat="2"></div>
          <div class="seat s3" data-seat="3"></div>
          <div class="seat s4" data-seat="4"></div>
          <div class="seat s5" data-seat="5"></div>
          <div class="seat s6" data-seat="6"></div>
          <div class="seat s7" data-seat="7"></div>
          <div id="table-center2">💰 Pot: <strong id="pot">0</strong></div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // ————————————————— Socket.IO: robust verbinden (WebSocket + Polling Fallback)
    const socket = io({
      path: '/socket.io',
      transports: ['websocket', 'polling']
    });
    const el = (s) => document.querySelector(s);

    // hilfreiche Status-Logs/Feedback
    socket.on('connect', () => {
      console.log('[socket] connected', socket.id);
      el('#adminStatus').textContent = 'Verbunden: ' + socket.id;
    });
    socket.on('connect_error', (err) => {
      console.warn('[socket] connect_error', err?.message || err);
      el('#adminStatus').textContent = 'Verbindungsfehler: ' + (err?.message || err);
    });
    socket.on('disconnect', (r) => {
      console.log('[socket] disconnected', r);
      el('#adminStatus').textContent = 'Getrennt: ' + r;
    });

    // kleiner Helfer: nur senden, wenn verbunden
    function emitIfConnected(event, payload) {
      if (!socket.connected) {
        el('#adminStatus').textContent = 'Nicht verbunden – bitte kurz warten oder neu laden.';
        return false;
      }
      socket.emit(event, payload);
      return true;
    }

    // ————————————————— UI: Buttons
    el('#btnCreate').onclick    = () => emitIfConnected('mod:create-room');
    el('#btnNextQ').onclick     = () => emitIfConnected('mod:next-question');
    el('#btnSetBlinds').onclick = () => {
      const small = el('#inpSB').value.trim();
      const big   = el('#inpBB').value.trim();
      emitIfConnected('mod:set-blinds', { small, big });
    };
    el('#btnSyncAll').onclick   = () => emitIfConnected('mod:sync-all');

    el('#btnMarkCorrect').onclick = () => {
      const uid = el('#uidTarget').value.trim(); if (!uid) return;
      const delta = parseInt(el('#deltaChips').value || '0', 10) || 0;
      emitIfConnected('mod:mark', { uid, result: 'correct', delta });
    };
    el('#btnMarkWrong').onclick = () => {
      const uid = el('#uidTarget').value.trim(); if (!uid) return;
      const delta = parseInt(el('#deltaChips').value || '0', 10) || 0;
      emitIfConnected('mod:mark', { uid, result: 'wrong', delta: -Math.abs(delta) });
    };
    el('#btnPlus').onclick = () => {
      const uid = el('#uidTarget').value.trim(); if (!uid) return;
      const delta = Math.abs(parseInt(el('#deltaChips').value || '0', 10) || 0);
      emitIfConnected('mod:adjust', { uid, delta });
    };
    el('#btnMinus').onclick = () => {
      const uid = el('#uidTarget').value.trim(); if (!uid) return;
      const delta = -Math.abs(parseInt(el('#deltaChips').value || '0', 10) || 0);
      emitIfConnected('mod:adjust', { uid, delta });
    };

    // ————————————————— State
    let lastVersion = -1;
    const playersMap = new Map();

    function renderPlayersPanel() {
      const wrap = el('#players'); wrap.innerHTML = '';
      const arr = Array.from(playersMap.values()).sort((a,b)=> a.name.localeCompare(b.name));
      arr.forEach(p => {
        const div = document.createElement('div');
        div.className = 'player';
        div.innerHTML = `
          <span title="UID: ${p.uid}">${p.name} ${p.connected? '🟢':'🔴'}</span>
          <strong>${p.chips || 0}</strong>
          <div class="pm">
            <button class="score-btn" data-uid="${p.uid}" data-d="+10">+10</button>
            <button class="score-btn" data-uid="${p.uid}" data-d="-10">-10</button>
          </div>`;
        wrap.appendChild(div);
      });
    }

    function renderSeats() {
      for (let i=0;i<8;i++) {
        const slot = document.querySelector(\`.seat[data-seat="\${i}"]\`);
        if (!slot) continue;
        slot.className = \`seat s\${i}\`;
        slot.innerHTML = '<div class="avatar">—</div><div class="name">Frei</div><div class="chips">🪙 0</div>';
      }
      const arr = Array.from(playersMap.values());
      arr.forEach(p => {
        if (typeof p.seat !== 'number') return;
        const slot = document.querySelector(\`.seat[data-seat="\${p.seat}"]\`);
        if (!slot) return;
        slot.innerHTML = \`<div class="avatar">🙂</div><div class="name">\${p.name}</div><div class="chips">🪙 \${p.chips ?? 0}</div>\`;
        if (!p.connected) slot.classList.add('disconnected');
      });
    }

    el('#players').addEventListener('click', (e) => {
      const btn = e.target.closest('.score-btn'); if (!btn) return;
      const uid = btn.dataset.uid; const delta = parseInt(btn.dataset.d, 10);
      emitIfConnected('mod:adjust', { uid, delta });
    });

    // ————————————————— Socket Events vom Server
    socket.on('mod:room-created', ({ code, state }) => {
      el('#roomCode').textContent = code;
      el('#adminStatus').textContent = 'Raum erstellt: ' + code;
      lastVersion = -1;
      playersMap.clear();
      (state.players || []).forEach(p => playersMap.set(p.uid, p));
      el('#qIndex').textContent = state.qIndex >= 0 ? (state.qIndex + 1) : '–';
      el('#questionBox').textContent = state.question?.text || '–';
      renderPlayersPanel(); renderSeats();
    });

    socket.on('state:full', (state) => {
      if ((state.version ?? -1) <= lastVersion) return;
      lastVersion = state.version ?? -1;
      playersMap.clear();
      (state.players || []).forEach(p => playersMap.set(p.uid, p));
      el('#qIndex').textContent = state.qIndex >= 0 ? (state.qIndex + 1) : '–';
      el('#questionBox').textContent = state.question?.text || '–';
      renderPlayersPanel(); renderSeats();
    });

    socket.on('players:update', (msg) => {
      if ((msg.version ?? -1) <= lastVersion) return;
      lastVersion = msg.version ?? -1;
      (msg.players || []).forEach(p => playersMap.set(p.uid, p));
      renderPlayersPanel(); renderSeats();
    });

    socket.on('question:show', (q) => {
      if ((q.version ?? -1) <= lastVersion) return;
      lastVersion = q.version ?? -1;
      el('#qIndex').textContent = (q.index + 1);
      el('#questionBox').textContent = q.text || '–';
      el('#answers').innerHTML = '';
    });

    socket.on('answer:received', ({ uid, name, answer }) => {
      const div = document.createElement('div');
      div.className = 'item';
      div.textContent = `${name}: ${answer}`;
      document.querySelector('#answers').prepend(div);
      el('#uidTarget').value = uid;
    });

    socket.on('result:correct', ({ name, delta }) => {
      el('#status').textContent = `✅ ${name} +${Math.abs(delta||0)} Chips`;
      setTimeout(() => el('#status').textContent = '', 1500);
    });
    socket.on('result:wrong', ({ name, delta }) => {
      el('#status').textContent = `❌ ${name} ${delta||0} Chips`;
      setTimeout(() => el('#status').textContent = '', 1500);
    });

    socket.on('status', (t) => { el('#adminStatus').textContent = t; });
  </script>
</body>
</html>
